<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–°–∫–ª–∞–¥ –∑–∞–ø—á–∞—Å—Ç–µ–π —Å —Ç–µ—Ö–Ω–∏–∫–æ–π</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f0f0f0; }
    input, button, select { padding: 6px; margin: 5px 5px 5px 0; }
    .edit-btn, .delete-btn, .install-btn { cursor: pointer; color: blue; }

    .modal {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); justify-content: center; align-items: center;
    }

    .modal-content {
      background: white; padding: 20px; border-radius: 5px; min-width: 300px;
    }

    .modal select, .modal input {
      width: 100%; margin-top: 5px;
    }
  </style>
</head>
<body>
<h2>–°–∫–ª–∞–¥ —Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–ø—á–∞—Å—Ç–µ–π</h2>

<input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫...">
<button onclick="toggleForm()">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é</button>
<button onclick="exportToExcel()">–≠–∫—Å–ø–æ—Ä—Ç —Å–∫–ª–∞–¥–∞</button>
<button onclick="exportTechPark()">–≠–∫—Å–ø–æ—Ä—Ç —Ç–µ—Ö–Ω–∏–∫–∏</button>
<button onclick="openTechManager()">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Ö–Ω–∏–∫–æ–π</button>

<table id="partsTable">
  <thead>
    <tr>
      <th>‚Ññ</th>
      <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
      <th>–ö–∞—Ç–∞–ª–æ–∂–Ω—ã–π –Ω–æ–º–µ—Ä</th>
      <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
      <th>–ú–µ—Å—Ç–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è</th>
      <th>–î–∞—Ç–∞ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è</th>
      <th>–î–∞—Ç–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏</th>
      <th>–¢–µ—Ö–Ω–∏–∫–∞</th>
      <th>–î–µ–π—Å—Ç–≤–∏—è</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div id="formRow" style="display:none;">
  <input id="name" placeholder="–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ">
  <input id="catalog" placeholder="–ö–∞—Ç–∞–ª–æ–∂–Ω—ã–π –Ω–æ–º–µ—Ä">
  <input type="number" id="quantity" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ">
  <input id="location" placeholder="–ú–µ—Å—Ç–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è">
  <input type="date" id="installed" placeholder="–î–∞—Ç–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏">
  <button onclick="saveEntry()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–µ—Ö–Ω–∏–∫–æ–π -->
<div class="modal" id="techModal">
  <div class="modal-content">
    <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Ö–Ω–∏–∫–æ–π</h3>
    <label>–ì—Ä—É–ø–ø–∞:</label>
    <select id="groupSelect" onchange="renderTechList()">
      <option value="–¢—Ä–∞–∫—Ç–æ—Ä">–¢—Ä–∞–∫—Ç–æ—Ä</option>
      <option value="–ö–æ–º–±–∞–π–Ω">–ö–æ–º–±–∞–π–Ω</option>
      <option value="–û–ø—Ä—ã—Å–∫–∏–≤–∞—Ç–µ–ª—å">–û–ø—Ä—ã—Å–∫–∏–≤–∞—Ç–µ–ª—å</option>
      <option value="–°–µ—è–ª–∫–∞">–°–µ—è–ª–∫–∞</option>
      <option value="–î—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
    </select>
    <ul id="techList"></ul>
    <input id="newTech" placeholder="–ù–æ–≤–∞—è —Ç–µ—Ö–Ω–∏–∫–∞">
    <button onclick="addTech()">–î–æ–±–∞–≤–∏—Ç—å</button>
    <button onclick="closeTechManager()">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>
<script>
  let partsData = [];
  let techGroups = JSON.parse(localStorage.getItem("techGroups") || '{}');
  let editIndex = null;

  function saveToLocalStorage() {
    localStorage.setItem("partsData", JSON.stringify(partsData));
    localStorage.setItem("techGroups", JSON.stringify(techGroups));
  }

  function toggleForm(edit = false, index = null) {
    const form = document.getElementById("formRow");
    form.style.display = form.style.display === "none" ? "block" : "none";

    if (!edit) {
      document.getElementById("name").value = "";
      document.getElementById("catalog").value = "";
      document.getElementById("quantity").value = "";
      document.getElementById("location").value = "";
      document.getElementById("installed").value = "";
      editIndex = null;
    } else {
      const item = partsData[index];
      document.getElementById("name").value = item.name;
      document.getElementById("catalog").value = item.catalog;
      document.getElementById("quantity").value = item.quantity;
      document.getElementById("location").value = item.location;
      document.getElementById("installed").value = item.installed || "";
      editIndex = index;
    }
  }

  function saveEntry() {
    const name = document.getElementById("name").value.trim();
    const catalog = document.getElementById("catalog").value.trim();
    const quantity = document.getElementById("quantity").value.trim();
    const location = document.getElementById("location").value.trim();
    const installed = document.getElementById("installed").value;

    if (!name || !catalog || !quantity || !location) {
      alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∫—Ä–æ–º–µ –¥–∞—Ç—ã —É—Å—Ç–∞–Ω–æ–≤–∫–∏");
      return;
    }

    const now = new Date();
    const arrival = now.toLocaleDateString("ru-RU");

    const entry = {
      name,
      catalog,
      quantity,
      location,
      installed,
      arrival,
      equipment: ""
    };

    if (editIndex !== null) {
      partsData[editIndex] = entry;
      editIndex = null;
    } else {
      partsData.push(entry);
    }

    saveToLocalStorage();
    renderTable();
    toggleForm(false);
  }

  function deleteRow(index) {
    if (confirm("–£–¥–∞–ª–∏—Ç—å?")) {
      partsData.splice(index, 1);
      saveToLocalStorage();
      renderTable();
    }
  }

  function installToday(index) {
    const maxQty = parseInt(partsData[index].quantity);
    const qty = parseInt(prompt(`–°–∫–æ–ª—å–∫–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å (–≤ –Ω–∞–ª–∏—á–∏–∏ ${maxQty})?`, "1"));
    if (isNaN(qty) || qty <= 0 || qty > maxQty) {
      alert("–ù–µ–≤–µ—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ");
      return;
    }

    const groups = Object.keys(techGroups);
    if (groups.length === 0) return alert("–ù–µ—Ç —Ç–µ—Ö–Ω–∏–∫–∏. –î–æ–±–∞–≤—å—Ç–µ —á–µ—Ä–µ–∑ '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Ö–Ω–∏–∫–æ–π'.");

    const group = prompt("–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É:\n" + groups.join("\n"));
    if (!group || !techGroups[group]) return;

    const list = techGroups[group];
    const tech = prompt("–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ—Ö–Ω–∏–∫—É:\n" + list.join("\n"));
    if (!tech) return;

    partsData[index].quantity -= qty;
    partsData[index].installed = new Date().toISOString().split("T")[0];
    partsData[index].equipment = tech;

    saveToLocalStorage();
    renderTable();
  }
  function renderTable() {
    const tbody = document.querySelector("#partsTable tbody");
    tbody.innerHTML = "";
    const filter = document.getElementById("searchInput").value.toLowerCase();

    partsData.forEach((item, index) => {
      if (
        item.name.toLowerCase().includes(filter) ||
        item.catalog.toLowerCase().includes(filter) ||
        item.location.toLowerCase().includes(filter)
      ) {
        const row = tbody.insertRow();
        row.insertCell(0).textContent = index + 1;
        row.insertCell(1).textContent = item.name;
        row.insertCell(2).textContent = item.catalog;
        row.insertCell(3).textContent = item.quantity;
        row.insertCell(4).textContent = item.location;
        row.insertCell(5).textContent = item.arrival;
        row.insertCell(6).textContent = item.installed || "";
        row.insertCell(7).textContent = item.equipment || "";
        row.insertCell(8).innerHTML = `
          <span class="edit-btn" onclick="toggleForm(true, ${index})">‚úè</span> |
          <span class="install-btn" onclick="installToday(${index})">üõ†</span> |
          <span class="delete-btn" onclick="deleteRow(${index})">üóë</span>`;
      }
    });
  }

  function exportToExcel() {
    const ws_data = [["‚Ññ", "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ", "–ö–∞—Ç–∞–ª–æ–∂–Ω—ã–π –Ω–æ–º–µ—Ä", "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ", "–ú–µ—Å—Ç–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è", "–î–∞—Ç–∞ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è", "–î–∞—Ç–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏", "–¢–µ—Ö–Ω–∏–∫–∞"]];
    partsData.forEach((item, index) => {
      ws_data.push([
        index + 1,
        item.name,
        item.catalog,
        item.quantity,
        item.location,
        item.arrival,
        item.installed || "",
        item.equipment || ""
      ]);
    });
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb, ws, "–°–∫–ª–∞–¥");
    XLSX.writeFile(wb, "sklad.xlsx");
  }

  function exportTechPark() {
    const XLSXData = [["–ì—Ä—É–ø–ø–∞", "–¢–µ—Ö–Ω–∏–∫–∞"]];
    for (const group in techGroups) {
      techGroups[group].forEach(item => XLSXData.push([group, item]));
    }
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(XLSXData);
    XLSX.utils.book_append_sheet(wb, ws, "–¢–µ—Ö–Ω–∏–∫–∞");
    XLSX.writeFile(wb, "techpark.xlsx");
  }

  function openTechManager() {
    document.getElementById("techModal").style.display = "flex";
    renderTechList();
  }

  function closeTechManager() {
    document.getElementById("techModal").style.display = "none";
  }

  function renderTechList() {
    const group = document.getElementById("groupSelect").value;
    const list = techGroups[group] || [];
    const ul = document.getElementById("techList");
    ul.innerHTML = "";
    list.forEach((tech, i) => {
      const li = document.createElement("li");
      li.textContent = tech + " ";
      const del = document.createElement("button");
      del.textContent = "–£–¥–∞–ª–∏—Ç—å";
      del.onclick = () => {
        techGroups[group].splice(i, 1);
        saveToLocalStorage();
        renderTechList();
      };
      li.appendChild(del);
      ul.appendChild(li);
    });
  }

  function addTech() {
    const group = document.getElementById("groupSelect").value;
    const newTech = document.getElementById("newTech").value.trim();
    if (!newTech) return;
    techGroups[group] = techGroups[group] || [];
    techGroups[group].push(newTech);
    document.getElementById("newTech").value = "";
    saveToLocalStorage();
    renderTechList();
  }

  window.onload = () => {
    partsData = JSON.parse(localStorage.getItem("partsData") || "[]");
    techGroups = JSON.parse(localStorage.getItem("techGroups") || "{}");
    renderTable();
  };

  document.getElementById("searchInput").addEventListener("input", renderTable);
</script>
</body>
</html>

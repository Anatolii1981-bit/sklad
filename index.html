<!DOCTYPE html>
<html lang="ua">
<head>
  <meta charset="UTF-8">
  <title>–°–∫–ª–∞–¥ –∑–∞–ø—á–∞—Å—Ç–∏–Ω</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f0f0f0; }
    input, button, select { padding: 6px; margin: 5px 5px 5px 0; }
    .edit-btn, .delete-btn, .install-btn, .history-btn { cursor: pointer; color: blue; }
    .modal {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); justify-content: center; align-items: center;
    }
    .modal-content {
      background: white; padding: 20px; border-radius: 5px; min-width: 300px;
    }
    #installRow {
      display: none;
      padding: 10px;
      border: 1px solid #ccc;
      margin-bottom: 20px;
      background: #f9f9f9;
    }
    #historyTable, #arrivalHistoryTable {
      margin-top: 30px;
    }
  </style>
</head>
<body>
  <div id="authScreen" style="position:fixed; top:0; left:0; width:100%; height:100%; background:white; display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:10000;">
  <h2>–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å –¥–ª—è –≤—Ö–æ–¥—É</h2>
  <input type="password" id="authInput" placeholder="–ü–∞—Ä–æ–ª—å">
  <button onclick="checkPassword()">–£–≤—ñ–π—Ç–∏</button>
  <p id="authMessage" style="color:red; margin-top:10px;"></p>
</div>

<h2>–°–∫–ª–∞–¥ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –∑–∞–ø—á–∞—Å—Ç–∏–Ω</h2>

<input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫..." oninput="renderTable()">
<button onclick="toggleForm()">–î–æ–±–∞–≤–∏—Ç–∏ –Ω–æ–≤—É</button>

<button onclick="openTechManager()">–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Ç–µ—Ö–Ω—ñ–∫–æ—é</button>
<button onclick="saveToJSON()">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –≤ JSON</button>
<input type="file" id="jsonFileInput" style="display:none" onchange="loadFromJSON(event)">
<button onclick="document.getElementById('jsonFileInput').click()">üìÇ –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —ñ–∑ JSON</button>
<button onclick="exportToExcel()">–≠–∫—Å–ø–æ—Ä—Ç —Å–∫–ª–∞–¥–∞</button>
<button onclick="exportTechPark()">–≠–∫—Å–ø–æ—Ä—Ç —Ç–µ—Ö–Ω—ñ–∫–∏</button>

<table id="partsTable">
  <thead>
    <tr>
      <th>‚Ññ</th>
      <th>–ö–∞—Ç–∞–ª–æ–∂–Ω–∏–π –Ω–æ–º–µ—Ä</th>
      <th>–ù–∞–π–º–µ–Ω—É–≤–∞–Ω–Ω—è</th>
      <th>–ö—ñ–ª—å–∫—ñ—Å—Ç—å</th>
      <th>–ú—ñ—Å—Ü–µ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è</th>
      <th>–î–∞—Ç–∞ –Ω–∞–¥—Ö–æ–¥–∂–µ–Ω–Ω—è</th>
      <th>–î–∞—Ç–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è</th>
      <th>–î–µ–π—Å—Ç–≤–∏—è</th>
     
    </tr>
  </thead>

  <tbody></tbody>
</table>

<div id="formRow" style="display:none;">
  <input id="catalog" placeholder="–ö–∞—Ç–∞–ª–æ–∂–Ω–∏–π –Ω–æ–º–µ—Ä">
  <input id="name" placeholder="–ù–∞–π–º–µ–Ω—É–≤–∞–Ω–Ω—è">
  <input type="number" id="quantity" placeholder="–ö—ñ–ª—å–∫—ñ—Å—Ç—å">
  <input id="location" placeholder="–ú—ñ—Å—Ü–µ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è">
  <input id="supplier" placeholder="–ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫">
  <input type="date" id="installed" placeholder="–î–∞—Ç–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è">
  <button onclick="saveEntry()">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
 
</div>

<div id="installRow">
  <strong>–í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ø—á–∞—Å—Ç–∏–Ω–∏:</strong><br>
  <label>–ö—ñ–ª—å–∫—ñ—Å—Ç—å:</label>
  <input type="number" id="installQty" placeholder="–°–∫—ñ–ª—å–∫–∏ –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏?">
  <label>–ì—Ä—É–ø–∞ —Ç–µ—Ö–Ω—ñ–∫–∏:</label>
  <select id="installGroup" onchange="updateTechOptions()">
    <option value="">-- –≤–∏–±–µ—Ä—ñ—Ç—å –≥—Ä—É–ø—É --</option>
    <option value="–¢—Ä–∞–∫—Ç–æ—Ä">–¢—Ä–∞–∫—Ç–æ—Ä</option>
    <option value="–ö–æ–º–±–∞–π–Ω">–ö–æ–º–±–∞–π–Ω</option>
    <option value="–û–ø—Ä–∏—Å–∫—É–≤–∞—á">–û–ø—Ä–∏—Å–∫—É–≤–∞—á</option>
    <option value="–°—ñ–≤–∞–ª–∫–∞">–°—ñ–≤–∞–ª–∫–∞</option>
    <option value="–Ü–Ω—à–µ">–Ü–Ω—à–µ</option>
  </select>
  <label>–¢–µ—Ö–Ω—ñ–∫–∞:</label>
  <select id="installTech">
    <option value="">-- –≤–∏–±–µ—Ä—ñ—Ç—å —Ç–µ—Ö–Ω—ñ–∫—É --</option>
  </select>
  <button onclick="confirmInstall()">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è</button>
  <button onclick="cancelInstall()">–í—ñ–¥–º—ñ–Ω–∞</button>
</div>
<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–µ—Ö–Ω–∏–∫–æ–π -->
<div class="modal" id="techModal">
  <div class="modal-content">
    <h3>–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Ç–µ—Ö–Ω—ñ–∫–æ—é</h3>
    <label>–ì—Ä—É–ø–∞:</label>
    <select id="groupSelect" onchange="renderTechList()">
      <option value="–¢—Ä–∞–∫—Ç–æ—Ä">–¢—Ä–∞–∫—Ç–æ—Ä</option>
      <option value="–ö–æ–º–±–∞–π–Ω">–ö–æ–º–±–∞–π–Ω</option>
      <option value="–û–ø—Ä–∏—Å–∫—É–≤–∞—á">–û–ø—Ä–∏—Å–∫—É–≤–∞—á</option>
      <option value="–°—ñ–≤–∞–ª–∫–∞">–°—ñ–≤–∞–ª–∫–∞</option>
      <option value="–Ü–Ω—à–µ">–Ü–Ω—à–µ</option>
    </select>
    <ul id="techList"></ul>
    <input id="newTech" placeholder="–ù–æ–≤–∞ —Ç–µ—Ö–Ω—ñ–∫–∞">
    <button onclick="addTech()">–î–æ–±–∞–≤–∏—Ç–∏</button>
    <button onclick="closeTechManager()">–ó–∞–∫—Ä–∏—Ç–∏</button>
  </div>
</div>

<!-- –Ü—Å—Ç–æ—Ä—ñ—è –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è -->
<h3>–Ü—Å—Ç–æ—Ä—ñ—è –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è</h3>
  <input type="text" id="historySearchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∫–∞—Ç–∞–ª–æ–∂–Ω–æ–º—É –Ω–æ–º–µ—Ä—É –Ω–∞–π–º–µ–Ω—É–≤–∞–Ω–Ω—è" oninput="renderHistory()">
  <button onclick="toggleHistory()">üìú –Ü—Å—Ç–æ—Ä—ñ—è –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è</button>

<div style="margin: 10px 0;">
  <label>–°:</label>
  <input type="date" id="installFrom">
  <label>–ü–æ:</label>
  <input type="date" id="installTo">
  <button onclick="exportFilteredInstallations()">üì§ –ï–∫—Å–ø–æ—Ä—Ç –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–æ –¥–∞—Ç—ñ</button>
</div>


<table id="historyTable" style="display:none;">
 <button onclick="clearInstallHistory()">üßπ –û—á–∏—Å—Ç–∏—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è</button>
 
  <thead>
    <tr>
      <th>–ö–∞—Ç–∞–ª–æ–∂–Ω–∏–π –Ω–æ–º–µ—Ä</th>
      <th>–ù–∞–π–º–µ–Ω—É–≤–∞–Ω–Ω—è</th>
      <th>–ö—ñ–ª—å–∫—ñ—Å—Ç—å</th>
      <th>–î–∞—Ç–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è</th>
      <th>–¢–µ—Ö–Ω—ñ–∫–∞</th>
    </tr>
  </thead>
  <tbody id="historyBody"></tbody>
</table>

<!-- –Ü—Å—Ç–æ—Ä—ñ—è –Ω–∞–¥—Ö–æ–¥–∂–µ–Ω—å -->
<h3>–Ü—Å—Ç–æ—Ä—ñ—è –Ω–∞–¥—Ö–æ–¥–∂–µ–Ω—å</h3>
 <input type="text" id="arrivalSearchInput" placeholder="–ü–æ—à—É–∫ –∑–∞ –∫–∞—Ç–∞–ª–æ–∂–Ω–∏–º –Ω–æ–º–µ—Ä–æ–º –∞–±–æ –Ω–∞–π–º–µ–Ω—É–≤–∞–Ω–Ω—è–º" oninput="renderArrivalHistory()">
  <button onclick="toggleArrivalHistory()">üì• –Ü—Å—Ç–æ—Ä—ñ—è –Ω–∞–¥—Ö–æ–¥–∂–µ–Ω—å</button>
<div style="margin: 10px 0;">
  <label>–°:</label>
  <input type="date" id="arrivalFrom">
  <label>–ü–æ:</label>
  <input type="date" id="arrivalTo">
  <button onclick="exportFilteredArrivals()">üì§ –ï–∫—Å–ø–æ—Ä—Ç –Ω–∞–¥—Ö–æ–¥–∂–µ–Ω—å –ø–æ –¥–∞—Ç—ñ</button>
</div>
  
<table id="arrivalHistoryTable" style="display:none;">
  <button onclick="clearArrivalHistory()">üßπ –û—á–∏—Å—Ç–∏—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é –Ω–∞–¥—Ö–æ–¥–∂–µ–Ω—å</button>

  <thead>
    <tr>
      <th>–ö–∞—Ç–∞–ª–æ–∂–Ω–∏–π –Ω–æ–º–µ—Ä</th>
      <th>–ù–∞–π–º–µ–Ω—É–≤–∞–Ω–Ω—è</th>
      <th>–ö—ñ–ª—å–∫—ñ—Å—Ç—å</th>
      <th>–î–∞—Ç–∞ –Ω–∞–¥—Ö–æ–¥–∂–µ–Ω—å</th>
      <th>–ú–µ—Å—Ü–µ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è</th>
      <th>–ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫</th>

    </tr>
  </thead>
  <tbody id="arrivalBody"></tbody>
</table>
<script>
let partsData = [];
let techGroups = JSON.parse(localStorage.getItem("techGroups") || '{}');
let historyLog = JSON.parse(localStorage.getItem("historyLog") || '[]');
let arrivalLog = JSON.parse(localStorage.getItem("arrivalLog") || '[]');

let editIndex = null;
let currentInstallIndex = null;
let historyVisible = false;
let arrivalVisible = false;

function saveToLocalStorage() {
  localStorage.setItem("partsData", JSON.stringify(partsData));
  localStorage.setItem("techGroups", JSON.stringify(techGroups));
  localStorage.setItem("historyLog", JSON.stringify(historyLog));
  localStorage.setItem("arrivalLog", JSON.stringify(arrivalLog));
}

function toggleHistory() {
  historyVisible = !historyVisible;
  document.getElementById("historyTable").style.display = historyVisible ? "table" : "none";
  renderHistory();
}

function toggleArrivalHistory() {
  arrivalVisible = !arrivalVisible;
  document.getElementById("arrivalHistoryTable").style.display = arrivalVisible ? "table" : "none";
  renderArrivalHistory();
}

setTimeout(() => {
  document.getElementById("catalog").addEventListener("input", () => {
    const cat = document.getElementById("catalog").value.trim().toLowerCase();
    const existing = partsData.find(p => p.catalog.toLowerCase() === cat);
    if (existing) {
      document.getElementById("name").value = existing.name;
      document.getElementById("location").value = existing.location;
    }
  });
}, 0);

window.onload = () => {
  toggleForm(false); // —Å–∫—Ä—ã—Ç—å —Ñ–æ—Ä–º—É –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
  partsData = JSON.parse(localStorage.getItem("partsData") || "[]");
  techGroups = JSON.parse(localStorage.getItem("techGroups") || "{}");
  historyLog = JSON.parse(localStorage.getItem("historyLog") || "[]");
  arrivalLog = JSON.parse(localStorage.getItem("arrivalLog") || "[]");
  renderTable();
  renderHistory();
  renderArrivalHistory();
   autoSaveIfDue();
};

function renderTable() {
  const tbody = document.querySelector("#partsTable tbody");
  tbody.innerHTML = "";
  const filter = document.getElementById("searchInput").value.toLowerCase();
  let counter = 1;

  partsData.forEach((item, index) => {
    if (
      item.quantity > 0 &&
      (item.name.toLowerCase().includes(filter) ||
       item.catalog.toLowerCase().includes(filter) ||
       item.location.toLowerCase().includes(filter))
    ) {
      const row = tbody.insertRow();
      row.insertCell(0).textContent = counter++;
row.insertCell(1).textContent = item.catalog;
row.insertCell(2).textContent = item.name;
row.insertCell(3).textContent = item.quantity;
row.insertCell(4).textContent = item.location;
row.insertCell(5).textContent = item.arrival;
row.insertCell(6).textContent = item.installed || "";
row.insertCell(7).innerHTML = `
  <span class="install-btn" onclick="startInstall(${index})">üõ†</span> |
  <span class="delete-btn" onclick="deleteRow(${index})">üóë</span>`;


    }
  });
}


function saveEntry() {
  const name = document.getElementById("name").value.trim();
  const catalog = document.getElementById("catalog").value.trim();
  const quantity = parseInt(document.getElementById("quantity").value.trim());
if (quantity <= 0) {
  alert("–ö—ñ–ª—å–∫—ñ—Å—Ç—å –ø–æ–≤–∏–Ω–Ω–∞ –±—É—Ç–∏ –±—ñ–ª—å—à–µ 0");
  return;
}

  const location = document.getElementById("location").value.trim();
  const installed = document.getElementById("installed").value;
  const supplier = document.getElementById("supplier").value.trim(); // üí° –≤–æ–∑–º–æ–∂–Ω–æ –∑–∞–±—ã–ª–∏ —ç—Ç–æ

  if (!name || !catalog || isNaN(quantity) || !location) {
    alert("–ó–∞–ø–æ–≤–Ω–∏—Ç–∏ –≤—Å—ñ  –ø–æ–ª—è");
    return;
  }

  const now = new Date();
  const arrival = now.toLocaleDateString("ru-RU");
  const entry = { name, catalog, quantity, location, installed, arrival, supplier };

  if (editIndex !== null) {
    partsData[editIndex] = entry;
    editIndex = null;
  } else {
    const existing = partsData.find(p => p.catalog.toLowerCase() === catalog.toLowerCase());
    if (existing) {
      existing.quantity += quantity;
      existing.arrival = arrival;
    } else {
      partsData.push(entry);
    }
    arrivalLog.push({ catalog, name, qty: quantity, date: arrival, location, supplier });
  }

  saveToLocalStorage();
  renderTable();
  // –æ—á–∏—â–∞–µ–º –ø–æ–ª—è
document.getElementById("name").value = "";
document.getElementById("catalog").value = "";
document.getElementById("quantity").value = "";
document.getElementById("location").value = "";
document.getElementById("supplier").value = "";
document.getElementById("installed").value = "";
document.getElementById("catalog").focus();

}

  function saveAndContinue() {
  const name = document.getElementById("name").value.trim();
  const catalog = document.getElementById("catalog").value.trim();
  const quantity = parseInt(document.getElementById("quantity").value.trim());
if (quantity <= 0) {
  alert("–ö—ñ–ª—å–∫—ñ—Å—Ç—å –ø–æ–≤–∏–Ω–Ω–∞ –±—É—Ç–∏ –±—ñ–ª—å—à–∞ –Ω—É–ª—è");
  return;
}

  const location = document.getElementById("location").value.trim();
  const installed = document.getElementById("installed").value;
  const supplier = document.getElementById("supplier").value.trim();

  if (!name || !catalog || isNaN(quantity) || !location) {
    alert("–ó–∞–ø–æ–≤–Ω–∏—Ç–∏ –≤—Å—ñ –ø–æ–ª—è");
    return;
  }

  const now = new Date();
  const arrival = now.toLocaleDateString("ru-RU");
  const entry = { name, catalog, quantity, location, installed, arrival, supplier };

  const existing = partsData.find(p => p.catalog.toLowerCase() === catalog.toLowerCase());
  if (existing) {
    existing.quantity += quantity;
    existing.arrival = arrival;
  } else {
    partsData.push(entry);
  }

  arrivalLog.push({ catalog, name, qty: quantity, date: arrival, location, supplier });

  saveToLocalStorage();
  renderTable();

  // –æ—á–∏—â–∞–µ–º –ø–æ–ª—è, –Ω–æ –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
  document.getElementById("name").value = "";
  document.getElementById("catalog").value = "";
  document.getElementById("quantity").value = "";
  document.getElementById("location").value = "";
  document.getElementById("supplier").value = "";
  document.getElementById("installed").value = "";
  document.getElementById("catalog").focus();
}


function confirmInstall() {
  const qty = parseInt(document.getElementById("installQty").value);
  const group = document.getElementById("installGroup").value;
  const tech = document.getElementById("installTech").value;
  if (currentInstallIndex === null || isNaN(qty) || qty <= 0 || !group || !tech) {
    alert("–ó–∞–ø–æ–≤–Ω–∏—Ç–∏ –≤—Å—ñ –ø–æ–ª—è –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è");
    return;
  }
  const part = partsData[currentInstallIndex];
  if (qty > part.quantity) {
    alert("–ù–µ–º–æ–∂–Ω–∞ –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –±—ñ–ª—å—à–µ, –Ω—ñ–∂ —î –Ω–∞ —Å–∫–ª–∞–¥—ñ");
    return;
  }

  part.quantity -= qty;
  part.installed = new Date().toISOString().split("T")[0];
  historyLog.push({
    catalog: part.catalog,
    name: part.name,
    qty,
    date: part.installed,
    tech: `${group} ‚Äî ${tech}`
  });

  saveToLocalStorage();
  renderTable();
  renderHistory();
  cancelInstall();
}

function cancelInstall() {
  currentInstallIndex = null;
  document.getElementById("installRow").style.display = "none";
}

function startInstall(index) {
  currentInstallIndex = index;
  document.getElementById("installQty").value = "";
  document.getElementById("installGroup").value = "";
  document.getElementById("installTech").innerHTML = '<option value="">-- –≤–∏–±–µ—Ä—ñ—Ç—å —Ç–µ—Ö–Ω—ñ–∫—É --</option>';
  document.getElementById("installRow").style.display = "block";
  window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
}

function deleteRow(index) {
  if (confirm("–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π —Ä—è–¥–æ–∫?")) {
    partsData.splice(index, 1);
    saveToLocalStorage();
    renderTable();
  }
}

function renderHistory(filterCatalog = null) {
  const tbody = document.getElementById("historyBody");
  tbody.innerHTML = "";

  const inputFilter = document.getElementById("historySearchInput")?.value.toLowerCase() || "";
  const catalogFilter = filterCatalog?.toLowerCase() || "";

  historyLog.forEach(entry => {
    const entryCatalog = entry.catalog.toLowerCase();
    const entryName = entry.name.toLowerCase();
    const matchesCatalog = !catalogFilter || entryCatalog === catalogFilter;
    const matchesInput = !inputFilter || entryCatalog.includes(inputFilter) || entryName.includes(inputFilter);

    if (matchesCatalog && matchesInput) {
      const row = tbody.insertRow();
      row.insertCell(0).textContent = entry.catalog;
      row.insertCell(1).textContent = entry.name;
      row.insertCell(2).textContent = entry.qty;
      row.insertCell(3).textContent = entry.date;
      row.insertCell(4).textContent = entry.tech;
    }
  });
}

function renderArrivalHistory() {
  const tbody = document.getElementById("arrivalBody");
  tbody.innerHTML = "";

  const inputFilter = document.getElementById("arrivalSearchInput")?.value.toLowerCase() || "";

  arrivalLog.forEach(entry => {
    const entryCatalog = entry.catalog.toLowerCase();
    const entryName = entry.name.toLowerCase();

    if (!inputFilter || entryCatalog.includes(inputFilter) || entryName.includes(inputFilter)) {
      const row = tbody.insertRow();
      row.insertCell(0).textContent = entry.catalog;
      row.insertCell(1).textContent = entry.name;
      row.insertCell(2).textContent = entry.qty;
      row.insertCell(3).textContent = entry.date;
      row.insertCell(4).textContent = entry.location;
      row.insertCell(5).textContent = entry.supplier || "";

    }
  });
}


function exportToExcel() {
  const ws_data = [["‚Ññ", "–ö–∞—Ç–∞–ª–æ–∂–Ω–∏–π –Ω–æ–º–µ—Ä", "–ù–∞–π–º–µ–Ω—É–≤–∞–Ω–Ω—è", "–ö—ñ–ª—å–∫—ñ—Å—Ç—å", "–ú–µ—Å—Ü–µ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è", "–î–∞—Ç–∞ –Ω–∞–¥—Ö–æ–¥–∂–µ–Ω–Ω—è", "–î–∞—Ç–∞ –≤—Å—Ç–µ–Ω–æ–≤–ª–µ–Ω–Ω—è"]];
  partsData.forEach((item, index) => {
    if (item.quantity > 0) {
      ws_data.push([
        index + 1,
        item.catalog,
        item.name,
        item.quantity,
        item.location,
        item.arrival,
        item.installed || ""
      ]);
    }
  });
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(ws_data);
  XLSX.utils.book_append_sheet(wb, ws, "–°–∫–ª–∞–¥");
  XLSX.writeFile(wb, "sklad.xlsx");
}

function exportHistoryToExcel() {
  const data = [["–ö–∞—Ç–∞–ª–æ–∂–Ω–∏–π–∏–π –Ω–æ–º–µ—Ä", "–ù–∞–π–º–µ–Ω—É–≤–∞–Ω–Ω—è", "–ö—ñ–ª—å–∫—ñ—Å—Ç—å", "–î–∞—Ç–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è", "–¢–µ—Ö–Ω—ñ–∫–∞"]];
  historyLog.forEach(h => {
    data.push([h.catalog, h.name, h.qty, h.date, h.tech]);
  });
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(data);
  XLSX.utils.book_append_sheet(wb, ws, "–Ü—Å—Ç–æ—Ä—ñ—è");
  XLSX.writeFile(wb, "history.xlsx");
}

function exportTechPark() {
  const data = [["–ì—Ä—É–ø–∞", "–¢–µ—Ö–Ω—ñ–∫–∞"]];
  for (let group in techGroups) {
    techGroups[group].forEach(tech => data.push([group, tech]));
  }
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(data);
  XLSX.utils.book_append_sheet(wb, ws, "–¢–µ—Ö–Ω—ñ–∫–∞");
  XLSX.writeFile(wb, "techpark.xlsx");
}

function saveToJSON() {
  const backup = { partsData, techGroups, historyLog, arrivalLog };
  const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'sklad_backup.json';
  a.click();
  URL.revokeObjectURL(url);
}

function loadFromJSON(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const json = JSON.parse(e.target.result);
      partsData = json.partsData || [];
      techGroups = json.techGroups || {};
      historyLog = json.historyLog || [];
      arrivalLog = json.arrivalLog || [];
      saveToLocalStorage();
      renderTable();
      renderHistory();
      renderArrivalHistory();
      alert("–î–∞–Ω—ñ —É—Å–ø—ñ—à–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ –∑ JSON!");
    } catch (err) {
      alert("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ JSON: " + err.message);
    }
  };
  reader.readAsText(file);
}

function openTechManager() {
  document.getElementById("techModal").style.display = "flex";
  renderTechList();
}

function closeTechManager() {
  document.getElementById("techModal").style.display = "none";
}

function renderTechList() {
  const group = document.getElementById("groupSelect").value;
  const list = techGroups[group] || [];
  const ul = document.getElementById("techList");
  ul.innerHTML = "";
  list.forEach((tech, i) => {
    const li = document.createElement("li");
    li.textContent = tech + " ";
    const del = document.createElement("button");
    del.textContent = "–í–∏–¥–∞–ª–∏—Ç–∏";
    del.onclick = () => {
      techGroups[group].splice(i, 1);
      saveToLocalStorage();
      renderTechList();
    };
    li.appendChild(del);
    ul.appendChild(li);
  });
}

function addTech() {
  const group = document.getElementById("groupSelect").value;
  const newTech = document.getElementById("newTech").value.trim();
  if (!newTech) return;
  techGroups[group] = techGroups[group] || [];
  techGroups[group].push(newTech);
  document.getElementById("newTech").value = "";
  saveToLocalStorage();
  renderTechList();
}
  function toggleForm(force = null) {
  const form = document.getElementById("formRow");
  if (!form) return;
  if (force === true) {
    form.style.display = "block";
  } else if (force === false) {
    form.style.display = "none";
  } else {
    form.style.display = (form.style.display === "none") ? "block" : "none";
  }
}

function updateTechOptions() {
  const group = document.getElementById("installGroup").value;
  const select = document.getElementById("installTech");
  select.innerHTML = '<option value="">-- –≤–∏–±–µ—Ä—ñ—Ç—å —Ç–µ—Ö–Ω—ñ–∫—É --</option>';

  if (group && techGroups[group]) {
    techGroups[group].forEach(tech => {
      const option = document.createElement("option");
      option.value = tech;
      option.textContent = tech;
      select.appendChild(option);
    });
  }
}
function exportFilteredArrivals() {
  const from = document.getElementById("arrivalFrom").value;
  const to = document.getElementById("arrivalTo").value;

  const data = [["–ö–∞—Ç–∞–ª–æ–≥–æ–≤–∏–π –Ω–æ–º–µ—Ä", "–ù–∞–π–º–µ–Ω—É–≤–∞–Ω–Ω—è", "–ö—ñ–ª—å–∫—ñ—Å—Ç—å", "–î–∞—Ç–∞ –Ω–∞–¥—Ö–æ–¥–∂–µ–Ω–Ω—è", "–ú—ñ—Å—Ü–µ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è"]];

  arrivalLog.forEach(entry => {
    const date = entry.date.split('.').reverse().join('-'); // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ ISO –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è

    if ((!from || date >= from) && (!to || date <= to)) {
      data.push([entry.catalog, entry.name, entry.qty, entry.date, entry.location]);
    }
  });

  if (data.length === 1) {
    alert("–ù–µ–º–∞—î –∑–∞–ø–∏—Å—ñ–≤ –∑–∞ –≤–∫–∞–∑–∞–Ω–∏–π –ø–µ—Ä—ñ–æ–¥.");
    return;
  }

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(data);
  XLSX.utils.book_append_sheet(wb, ws, "–ù–∞–¥—Ö–æ–¥–∂–µ–Ω–Ω—è");
  XLSX.writeFile(wb, "arrival_filtered.xlsx");
}
  function exportFilteredInstallations() {
  const from = document.getElementById("installFrom").value;
  const to = document.getElementById("installTo").value;

  const data = [["–ö–∞—Ç–∞–ª–æ–∂–Ω–∏–π –Ω–æ–º–µ—Ä", "–ù–∞–π–º–µ–Ω—É–≤–∞–Ω–Ω—è", "–ö—ñ–ª—å–∫—ñ—Å—Ç—å", "–î–∞—Ç–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è", "–¢–µ—Ö–Ω—ñ–∫–∞"]];

  historyLog.forEach(entry => {
    const date = entry.date.split('.').reverse().join('-');
    if ((!from || date >= from) && (!to || date <= to)) {
      data.push([entry.catalog, entry.name, entry.qty, entry.date, entry.tech]);
    }
  });

  if (data.length === 1) {
    alert("–ù–µ–º–∞—î —É—Å—Ç–∞–Ω–æ–≤–æ–∫ –∑–∞ –≤–∫–∞–∑–∞–Ω–∏–π –ø–µ—Ä—ñ–æ–¥.");
    return;
  }

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(data);
  XLSX.utils.book_append_sheet(wb, ws, "–í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è");
  XLSX.writeFile(wb, "installations_filtered.xlsx");
}
function clearInstallHistory() {
  const pin = prompt("–í–≤–µ–¥—ñ—Ç—å PIN-–∫–æ–¥ –¥–ª—è –æ—á–∏—â–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó —É—Å—Ç–∞–Ω–æ–≤–æ–∫:");
  if (pin === "0918") {
    if (confirm("–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—é —ñ—Å—Ç–æ—Ä—ñ—é —É—Å—Ç–∞–Ω–æ–≤–æ–∫?")) {
      historyLog = [];
      saveToLocalStorage();
      renderHistory();
      alert("–Ü—Å—Ç–æ—Ä—ñ—è –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—å –æ—á–∏—â–µ–Ω–∞.");
    }
  } else {
    alert("–ù–µ–≤—ñ—Ä–Ω–∏–π PIN.");
  }
}

function clearArrivalHistory() {
  const pin = prompt("–í–≤–µ–¥—ñ—Ç—å PIN-–∫–æ–¥ –¥–ª—è –æ—á–∏—â–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó –Ω–∞–¥—Ö–æ–¥–∂–µ–Ω—å:");
  if (pin === "0918") {
    if (confirm("–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—é —ñ—Å—Ç–æ—Ä—ñ—é –Ω–∞–¥—Ö–æ–¥–∂–µ–Ω—å?")) {
      arrivalLog = [];
      saveToLocalStorage();
      renderArrivalHistory();
      alert("–Ü—Å—Ç–æ—Ä—ñ—è –Ω–∞–¥—Ö–æ–¥–∂–µ–Ω—å –æ—á–∏—â–µ–Ω–∞.");
    }
  } else {
    alert("–ù–µ–≤—ñ—Ä–Ω–∏–π PIN.");
  }
}
function autoSaveIfDue() {
  const lastSave = localStorage.getItem("lastAutoJsonSave");
  const now = Date.now();

  if (!lastSave || now - parseInt(lastSave) > 10 * 24 * 60 * 60 * 1000) {
    saveToJSON();
    localStorage.setItem("lastAutoJsonSave", now.toString());
    console.log("–ê–≤—Ç–æ–∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è JSON: –º–∏–Ω—É–ª–æ 10 –¥–Ω—ñ–≤.");
  } else {
    console.log("–ê–≤—Ç–æ–∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è JSON: –Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ.");
  }
}
function checkPassword() {
  const input = document.getElementById("authInput").value;
  const message = document.getElementById("authMessage");

  if (input === "1234") { // ‚Üê –∑–¥–µ—Å—å –ø–∞—Ä–æ–ª—å
    document.getElementById("authScreen").style.display = "none";
  } else {
    message.textContent = "–í –¥–æ—Å—Ç—É–ø—ñ –≤—ñ–¥–º–æ–≤–ª–µ–Ω–æ";
  }
}


</script>
</body>
</html>





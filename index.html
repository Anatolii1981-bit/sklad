<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>–°–∫–ª–∞–¥ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –∑–∞–ø—á–∞—Å—Ç–∏–Ω</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-database-compat.js"></script>
  
  <!-- XLSX -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>


  <style>
    body { font-family: sans-serif; padding: 20px; }
    table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f0f0f0; }
    input, button, select { padding: 6px; margin: 5px 5px 5px 0; }
    .edit-btn, .delete-btn, .install-btn, .history-btn { cursor: pointer; color: blue; }
    .modal {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); justify-content: center; align-items: center;
    }
    .modal-content {
  background: white;
  padding: 20px;
  border-radius: 5px;
  min-width: 300px;
  max-height: 90vh;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
}

  </style>
</head>

<body>
<!-- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è -->
<div id="authScreen" style="position:fixed; top:0; left:0; width:100%; height:100%; background:white; display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:10000;">
  <h2>–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å –¥–ª—è –≤—Ö–æ–¥—É</h2>
  <input type="password" id="authInput" placeholder="–ü–∞—Ä–æ–ª—å">
  <button onclick="checkPassword()">–£–≤—ñ–π—Ç–∏</button>
  <p id="authMessage" style="color:red; margin-top:10px;"></p>
</div>

<h2>–°–∫–ª–∞–¥ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –∑–∞–ø—á–∞—Å—Ç–∏–Ω</h2>
<input type="text" id="searchInput" placeholder="–ü–æ—à—É–∫..." oninput="renderTable()">
<button onclick="toggleForm()">–î–æ–¥–∞—Ç–∏ –Ω–æ–≤—É</button>
<button onclick="openTechManager()">–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Ç–µ—Ö–Ω—ñ–∫–æ—é</button>
<button onclick="exportToExcel()">üì§ –ï–∫—Å–ø–æ—Ä—Ç —Å–∫–ª–∞–¥—É</button>
<button onclick="exportTechPark()">üì§ –ï–∫—Å–ø–æ—Ä—Ç —Ç–µ—Ö–Ω—ñ–∫–∏</button>
<button onclick="refreshData()">üîÑ –û–Ω–æ–≤–∏—Ç–∏ –¥–∞–Ω—ñ</button>
  <h3>üìÑ –Ü–º–ø–æ—Ä—Ç –∑ .docx-—Ñ–∞–π–ª—É</h3>
<input type="file" id="docxInput" accept=".docx">
<button onclick="handleDocxImport()">–Ü–º–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ –∑ Word</button>

<button onclick="logout()">üö™ –í–∏–π—Ç–∏</button>

<table id="partsTable">
  <thead>
    <tr>
      <th>‚Ññ</th>
      <th>–ö–∞—Ç–∞–ª–æ–∂–Ω–∏–π –Ω–æ–º–µ—Ä</th>
      <th>‚Ññ –Ω–µ –æ—Ä–∏–≥—ñ–Ω–∞–ª</th>
      <th>–ù–∞–π–º–µ–Ω—É–≤–∞–Ω–Ω—è</th>
      <th>–ö—ñ–ª—å–∫—ñ—Å—Ç—å</th>
      <th>–ú—ñ—Å—Ü–µ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è</th>
      <th>–î–∞—Ç–∞ –Ω–∞–¥—Ö–æ–¥–∂–µ–Ω–Ω—è</th>
      <th>–î–∞—Ç–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è</th>
      <th>–î—ñ—ó</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<!-- –§–æ—Ä–º–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è -->
<div id="formRow" style="display:none;">
  <input id="catalog" placeholder="–ö–∞—Ç–∞–ª–æ–∂–Ω–∏–π –Ω–æ–º–µ—Ä" autofocus>
  <input id="altCatalog" placeholder="‚Ññ –Ω–µ –æ—Ä–∏–≥—ñ–Ω–∞–ª">
  <input id="name" placeholder="–ù–∞–π–º–µ–Ω—É–≤–∞–Ω–Ω—è">
 <input type="number" id="quantity" placeholder="–ö—ñ–ª—å–∫—ñ—Å—Ç—å" min="0.01" step="0.01">

  <input id="location" placeholder="–ú—ñ—Å—Ü–µ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è">
  <input id="supplier" placeholder="–ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫">
  <input type="date" id="installed">
  <button onclick="saveEntry()">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
</div>

<!-- –ë–ª–æ–∫ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è -->
<div id="installBlock" style="display:none; margin:20px 0; padding:10px; border:1px solid #ccc;">
  <strong>–í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ø—á–∞—Å—Ç–∏–Ω–∏:</strong><br>
  <label>–ö—ñ–ª—å–∫—ñ—Å—Ç—å:</label>
  <input type="number" id="installQty" min="0.01" step="0.01" placeholder="–°–∫—ñ–ª—å–∫–∏ –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏?">

  <label>–ì—Ä—É–ø–∞ —Ç–µ—Ö–Ω—ñ–∫–∏:</label>
  <select id="installGroup" onchange="updateTechOptions()">
    <option value="">-- –≤–∏–±–µ—Ä—ñ—Ç—å –≥—Ä—É–ø—É --</option>
    <option value="–¢—Ä–∞–∫—Ç–æ—Ä">–¢—Ä–∞–∫—Ç–æ—Ä</option>
    <option value="–ö–æ–º–±–∞–π–Ω">–ö–æ–º–±–∞–π–Ω</option>
    <option value="–û–ø—Ä–∏—Å–∫—É–≤–∞—á">–û–ø—Ä–∏—Å–∫—É–≤–∞—á</option>
    <option value="–°—ñ–≤–∞–ª–∫–∞">–°—ñ–≤–∞–ª–∫–∞</option>
    <option value="–ñ–∞—Ç–∫–∏">–ñ–∞—Ç–∫–∏</option>
  <option value="–ê–≤—Ç–æ–º–æ–±—ñ–ª—ñ">–ê–≤—Ç–æ–º–æ–±—ñ–ª—ñ</option>
  <option value="–ì—Ä—É–Ω—Ç–æ–æ–±—Ä–æ–±–Ω–∞">–ì—Ä—É–Ω—Ç–æ–æ–±—Ä–æ–±–Ω–∞</option>
    <option value="–Ü–Ω—à–µ">–Ü–Ω—à–µ</option>
  </select>
  <label>–¢–µ—Ö–Ω—ñ–∫–∞:</label>
  <select id="installTech">
    <option value="">-- –≤–∏–±–µ—Ä—ñ—Ç—å —Ç–µ—Ö–Ω—ñ–∫—É --</option>
  </select>
  <button onclick="confirmInstall()">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è</button>
  <button onclick="cancelInstall()">–í—ñ–¥–º—ñ–Ω–∞</button>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–µ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Ç–µ—Ö–Ω—ñ–∫–æ—é -->
<div class="modal" id="techModal">
 <div class="modal-content">
  <h3>–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Ç–µ—Ö–Ω—ñ–∫–æ—é</h3>

  <label>–ì—Ä—É–ø–∞:</label>
  <select id="groupSelect" onchange="renderTechList()">
    <option value="–¢—Ä–∞–∫—Ç–æ—Ä">–¢—Ä–∞–∫—Ç–æ—Ä</option>
    <option value="–ö–æ–º–±–∞–π–Ω">–ö–æ–º–±–∞–π–Ω</option>
    <option value="–û–ø—Ä–∏—Å–∫—É–≤–∞—á">–û–ø—Ä–∏—Å–∫—É–≤–∞—á</option>
    <option value="–°—ñ–≤–∞–ª–∫–∞">–°—ñ–≤–∞–ª–∫–∞</option>
    <option value="–ñ–∞—Ç–∫–∏">–ñ–∞—Ç–∫–∏</option>
  <option value="–ê–≤—Ç–æ–º–æ–±—ñ–ª—ñ">–ê–≤—Ç–æ–º–æ–±—ñ–ª—ñ</option>
  <option value="–ì—Ä—É–Ω—Ç–æ–æ–±—Ä–æ–±–Ω–∞">–ì—Ä—É–Ω—Ç–æ–æ–±—Ä–æ–±–Ω–∞</option>
    <option value="–Ü–Ω—à–µ">–Ü–Ω—à–µ</option>
  </select>

  <table style="width:100%; margin-top:10px; border-collapse: collapse;" border="1">
    <thead>
      <tr>
        <th>–ù–∞–∑–≤–∞</th>
        <th>–í–Ω—É—Ç—Ä. –Ω–æ–º–µ—Ä</th>
        <th>–û–ø–µ—Ä–∞—Ç–æ—Ä</th>
        <th>‚ùå</th>
      </tr>
    </thead>
    <tbody id="techList"></tbody>
  </table>

  <div style="margin-top:10px;">
    <input id="newTechName" placeholder="–ù–∞–∑–≤–∞">
   
    <input id="newTechInternal" placeholder="–í–Ω—É—Ç—Ä. –Ω–æ–º–µ—Ä">
    <input id="newTechOperator" placeholder="–û–ø–µ—Ä–∞—Ç–æ—Ä">
    <button onclick="addTech()">–î–æ–¥–∞—Ç–∏</button>
    <button onclick="closeTechManager()">–ó–∞–∫—Ä–∏—Ç–∏</button>
  </div>
</div>

</div>

<!-- –Ü—Å—Ç–æ—Ä—ñ—è –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è -->
<h3>–Ü—Å—Ç–æ—Ä—ñ—è –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è</h3>
<input type="text" id="historySearchInput" placeholder="–ü–æ—à—É–∫ –ø–æ –∫–∞—Ç–∞–ª–æ–∂–Ω–æ–º—É –Ω–æ–º–µ—Ä—É –∞–±–æ –Ω–∞–π–º–µ–Ω—É–≤–∞–Ω–Ω—é" oninput="renderHistory()">
<button onclick="toggleHistory()">üìú –ü–æ–∫–∞–∑–∞—Ç–∏/—Å—Ö–æ–≤–∞—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è</button>
<button onclick="toggleInstallExport()">üì§ –ï–∫—Å–ø–æ—Ä—Ç –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—å –ø–æ –¥–∞—Ç—ñ</button>
<div id="installExportBlock" style="display:none; margin: 10px 0;">
  <label>–ó:</label>
  <input type="date" id="installFrom">
  <label>–ü–æ:</label>
  <input type="date" id="installTo">
  <button onclick="exportFilteredInstallations()">üì§ –í–∏–∫–æ–Ω–∞—Ç–∏ –µ–∫—Å–ø–æ—Ä—Ç</button>
</div>

  <button onclick="clearInstallHistory()">üßπ –û—á–∏—Å—Ç–∏—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è</button>

</div>
<table id="historyTable" style="display:none;">
  <thead>
    <tr>
      <th>–ö–∞—Ç–∞–ª–æ–∂–Ω–∏–π –Ω–æ–º–µ—Ä</th>
      <th>‚Ññ –Ω–µ –æ—Ä–∏–≥—ñ–Ω–∞–ª</th>
      <th>–ù–∞–π–º–µ–Ω—É–≤–∞–Ω–Ω—è</th>
      <th>–ö—ñ–ª—å–∫—ñ—Å—Ç—å</th>
      <th>–î–∞—Ç–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è</th>
      <th>–¢–µ—Ö–Ω—ñ–∫–∞</th>
      <th>–í–Ω—É—Ç—Ä. –Ω–æ–º–µ—Ä</th>
<th>–û–ø–µ—Ä–∞—Ç–æ—Ä</th>
       <th>‚ùå</th>
    </tr>
  </thead>
  <tbody id="historyBody"></tbody>
</table>

<!-- –Ü—Å—Ç–æ—Ä—ñ—è –Ω–∞–¥—Ö–æ–¥–∂–µ–Ω—å -->
<h3>–Ü—Å—Ç–æ—Ä—ñ—è –Ω–∞–¥—Ö–æ–¥–∂–µ–Ω—å</h3>
<input type="text" id="arrivalSearchInput" placeholder="–ü–æ—à—É–∫ –ø–æ –∫–∞—Ç–∞–ª–æ–∂–Ω–æ–º—É –Ω–æ–º–µ—Ä—É –∞–±–æ –Ω–∞–π–º–µ–Ω—É–≤–∞–Ω–Ω—é" oninput="renderArrivalHistory()">
<button onclick="toggleArrivalHistory()">üì• –ü–æ–∫–∞–∑–∞—Ç–∏/—Å—Ö–æ–≤–∞—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é –Ω–∞–¥—Ö–æ–¥–∂–µ–Ω—å</button>
<button onclick="toggleArrivalExport()">üì§ –ï–∫—Å–ø–æ—Ä—Ç –Ω–∞–¥—Ö–æ–¥–∂–µ–Ω—å –ø–æ –¥–∞—Ç—ñ</button>
<div id="arrivalExportBlock" style="display:none; margin: 10px 0;">
  <label>–ó:</label>
  <input type="date" id="arrivalFrom">
  <label>–ü–æ:</label>
  <input type="date" id="arrivalTo">
  <button onclick="exportFilteredArrivals()">üì§ –í–∏–∫–æ–Ω–∞—Ç–∏ –µ–∫—Å–ø–æ—Ä—Ç</button>
</div>

  <button onclick="clearArrivalHistory()">üßπ –û—á–∏—Å—Ç–∏—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é –Ω–∞–¥—Ö–æ–¥–∂–µ–Ω—å</button>

</div>
<table id="arrivalHistoryTable" style="display:none;">
  <thead>
    <tr>
      <th>–ö–∞—Ç–∞–ª–æ–∂–Ω–∏–π –Ω–æ–º–µ—Ä</th>
      <th>‚Ññ –Ω–µ –æ—Ä–∏–≥—ñ–Ω–∞–ª</th>
      <th>–ù–∞–π–º–µ–Ω—É–≤–∞–Ω–Ω—è</th>
      <th>–ö—ñ–ª—å–∫—ñ—Å—Ç—å</th>
      <th>–î–∞—Ç–∞ –Ω–∞–¥—Ö–æ–¥–∂–µ–Ω–Ω—è</th>
      <th>–ú—ñ—Å—Ü–µ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è</th>
      <th>–ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫</th>
      <th>‚ùå</th>
    </tr>
  </thead>
  <tbody id="arrivalBody"></tbody>
</table>

<!-- –û—Å–Ω–æ–≤–Ω–∏–π —Å–∫—Ä–∏–ø—Ç –ø—ñ–¥–µ –≤ –Ω–∞—Å—Ç—É–ø–Ω—ñ–π —á–∞—Å—Ç–∏–Ω—ñ! -->
<script>
// --- Firebase –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è ---
const firebaseConfig = {
  apiKey: "AIzaSyDcUKoOroCPgK2tg_zBv9WIji2VYsUTCZU",
  authDomain: "sklad-c6daf.firebaseapp.com",
  databaseURL: "https://sklad-c6daf-default-rtdb.europe-west1.firebasedatabase.app/",
  projectId: "sklad-c6daf",
  storageBucket: "sklad-c6daf.appspot.com",
  messagingSenderId: "1033169323962",
  appId: "1:1033169323962:web:73dd54812574d48aeabf83"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// --- –ì–ª–æ–±–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ ---
let partsData = [];
let techGroups = {};
let historyLog = [];
let arrivalLog = [];
let editIndex = null;
let currentInstallIndex = null;
let historyVisible = false;
let arrivalVisible = false;

// --- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è ---
function checkPassword() {
  const input = document.getElementById("authInput").value;
  if (input === "Kuznetsov0104") {
    localStorage.setItem("authPassed", "true");
    document.getElementById("authScreen").style.display = "none";
  } else {
    document.getElementById("authMessage").textContent = "–í –¥–æ—Å—Ç—É–ø—ñ –≤—ñ–¥–º–æ–≤–ª–µ–Ω–æ!";
  }
}

function logout() {
  localStorage.removeItem("authPassed");
  location.reload();
}

// --- –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ ---
window.onload = async () => {
  if (localStorage.getItem("authPassed") === "true") {
    document.getElementById("authScreen").style.display = "none";
  }

  await loadFromFirebase(); // ‚úÖ partsData –≤–∂–µ —î

  // --- –ê–≤—Ç–æ–∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è –Ω–∞–π–º–µ–Ω—É–≤–∞–Ω–Ω—è –∑–∞ –∫–∞—Ç–∞–ª–æ–∂–Ω–∏–º –Ω–æ–º–µ—Ä–æ–º ---
  document.getElementById("catalog").addEventListener("input", function () {
    const catalogInput = this.value.trim().toLowerCase();
    const found = partsData.find(p => p.catalog.toLowerCase() === catalogInput);
    if (found) {
      document.getElementById("name").value = found.name;
    } else {
      document.getElementById("name").value = "";
    }
  });
};


// --- –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ç–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑ Firebase ---
async function saveToFirebase() {
  await db.ref('warehouse').set({ partsData, techGroups, historyLog, arrivalLog });
}

async function loadFromFirebase() {
  return db.ref('warehouse').once('value').then(snapshot => {
    const data = snapshot.val();
    if (data) {
      partsData = data.partsData || [];
      techGroups = data.techGroups || {};
      historyLog = data.historyLog || [];
      arrivalLog = data.arrivalLog || [];
    }
    renderTable();
    renderHistory();
    renderArrivalHistory();
  });
}

function refreshData() {
  loadFromFirebase();
  alert("–î–∞–Ω—ñ –æ–Ω–æ–≤–ª–µ–Ω—ñ! ‚úÖ");
}
// --- –§–æ—Ä–º–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è ---
function toggleForm(force = null) {
  const form = document.getElementById("formRow");
  if (force === true) {
    form.style.display = "block";
    clearForm();
  } else if (force === false) {
    form.style.display = "none";
  } else {
    form.style.display = (form.style.display === "none") ? "block" : "none";
    if (form.style.display === "block") clearForm();
  }
}

function clearForm() {
  document.getElementById("catalog").value = "";
  document.getElementById("altCatalog").value = ""; // üÜï –î–û–î–ê–ô –¶–ï–ô –†–Ø–î–û–ö
  document.getElementById("name").value = "";
  document.getElementById("quantity").value = "";
  document.getElementById("location").value = "";
  document.getElementById("supplier").value = "";
  document.getElementById("installed").value = "";
  document.getElementById("catalog").focus();
}

async function saveEntry() {
  const name = document.getElementById("name").value.trim();
  const catalog = document.getElementById("catalog").value.trim();
  const altCatalog = document.getElementById("altCatalog").value.trim();  // üÜï –¥–æ–¥–∞–Ω–æ
 const quantityInput = document.getElementById("quantity").value.trim().replace(",", ".");
const quantity = parseFloat(quantityInput);

 

  const location = document.getElementById("location").value.trim();
  const supplier = document.getElementById("supplier").value.trim();
  const installed = document.getElementById("installed").value;

  if (!name || !catalog || isNaN(quantity) || quantity <= 0 || !location || !supplier) {
    alert("–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ!");
    return;
  }

  const now = new Date();
  const arrival = now.toLocaleDateString("uk-UA");
  const entry = { name, catalog, altCatalog, quantity, location, installed, arrival, supplier };  // üÜï –¥–æ–¥–∞–Ω–æ altCatalog

  const existing = partsData.find(p => p.catalog.toLowerCase() === catalog.toLowerCase());
  if (existing) {
    existing.quantity += quantity;
    existing.arrival = arrival;
  } else {
    partsData.push(entry);
  }

  arrivalLog.push({
    catalog,
    altCatalog,  // üÜï –¥–æ–¥–∞–Ω–æ altCatalog –≤ —ñ—Å—Ç–æ—Ä—ñ—é –Ω–∞–¥—Ö–æ–¥–∂–µ–Ω—å
    name,
    qty: quantity,
    date: arrival,
    location,
    supplier
  });

  await saveToFirebase();
  renderTable();
  renderArrivalHistory();
  clearForm();
  alert("–ó–∞–ø—á–∞—Å—Ç–∏–Ω—É –∑–±–µ—Ä–µ–∂–µ–Ω–æ!");
}


// --- –ü–æ–±—É–¥–æ–≤–∞ —Ç–∞–±–ª–∏—Ü—ñ —Å–∫–ª–∞–¥—É ---
function renderTable() {
  const tbody = document.querySelector("#partsTable tbody");
  tbody.innerHTML = "";
  const filter = document.getElementById("searchInput").value.toLowerCase();
  let counter = 1;

  partsData.forEach((item, index) => {
    if (item.quantity > 0 &&
      (item.name.toLowerCase().includes(filter) ||
       item.catalog.toLowerCase().includes(filter) ||
       item.location.toLowerCase().includes(filter))) {
      const row = tbody.insertRow();
      row.insertCell(0).textContent = counter++;
      row.insertCell(1).textContent = item.catalog;
      row.insertCell(2).textContent = item.altCatalog || "";
      row.insertCell(3).textContent = item.name;
      row.insertCell(4).textContent = item.quantity;
      row.insertCell(5).textContent = item.location;
      row.insertCell(6).textContent = item.arrival;
      row.insertCell(7).textContent = item.installed || "";
      row.insertCell(8).innerHTML = `
  <span class="install-btn" onclick="startInstall(${index})">üõ†</span> |
  <span class="edit-btn" onclick="editLocation(${index})">‚úèÔ∏è</span> |
  <span class="delete-btn" onclick="deleteRow(${index})">üóë</span>
`;
    }
  });
}
// --- –ü–æ—á–∞—Ç–∏ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è ---
function startInstall(index) {
  currentInstallIndex = index;
  const block = document.getElementById("installBlock");
  document.getElementById("installQty").value = "";
  document.getElementById("installGroup").value = "";
  document.getElementById("installTech").innerHTML = '<option value="">-- –≤–∏–±–µ—Ä—ñ—Ç—å —Ç–µ—Ö–Ω—ñ–∫—É --</option>';
  block.style.display = "block";
  document.getElementById("installQty").focus();
}

// --- –°–∫–∞—Å—É–≤–∞—Ç–∏ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è ---
function cancelInstall() {
  document.getElementById("installBlock").style.display = "none";
  currentInstallIndex = null;
}

// --- –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è ---
async function confirmInstall() {
  const qtyInput = document.getElementById("installQty").value.trim().replace(",", ".");
const qty = parseFloat(qtyInput);

 
  const group = document.getElementById("installGroup").value;
  const tech = document.getElementById("installTech").value;

  if (!currentInstallIndex && currentInstallIndex !== 0) {
    alert("–ù–µ –≤–∏–±—Ä–∞–Ω–æ –∑–∞–ø—á–∞—Å—Ç–∏–Ω—É!");
    return;
  }

  if (isNaN(qty) || qty <= 0) {
    alert("–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω—É –∫—ñ–ª—å–∫—ñ—Å—Ç—å!");
    return;
  }
  if (!group || !tech) {
    alert("–û–±–µ—Ä—ñ—Ç—å –≥—Ä—É–ø—É —Ç–∞ —Ç–µ—Ö–Ω—ñ–∫—É!");
    return;
  }

  const item = partsData[currentInstallIndex];
  if (item.quantity < qty) {
    alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—è –∫—ñ–ª—å–∫—ñ—Å—Ç—å –Ω–∞ —Å–∫–ª–∞–¥—ñ!");
    return;
  }

  item.quantity -= qty;
  item.quantity = parseFloat(item.quantity.toFixed(2)); // ‚úÖ –û–ö–†–£–ì–õ–ï–ù–ù–Ø

  const installDate = new Date().toLocaleDateString("uk-UA");
  item.installed = installDate;

  const groupList = techGroups[group] || [];
  const techObj = groupList.find(t => t.name === tech) || {};

  historyLog.push({
    catalog: item.catalog,
    altCatalog: item.altCatalog || "",
    name: item.name,
    qty,
    date: installDate,
    tech,
    internal: techObj.internal || "",
    operator: techObj.operator || ""
  });

  currentInstallIndex = null;
  document.getElementById("installBlock").style.display = "none";
  await saveToFirebase();
  renderTable();
  renderHistory();
  alert("–í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ø–∏—Å–∞–Ω–æ! ‚úÖ");
}

// --- –í–∏–¥–∞–ª–µ–Ω–Ω—è –∑–∞–ø—á–∞—Å—Ç–∏–Ω–∏ ---
async function deleteRow(index) {
  const item = partsData[index];
  const confirmDelete = confirm(`–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ –∑–∞–ø—á–∞—Å—Ç–∏–Ω—É: ${item.name}?`);
  if (!confirmDelete) return;

  partsData.splice(index, 1);
  await saveToFirebase();
  renderTable();
}
// --- –í—ñ–¥–∫—Ä–∏—Ç–∏ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Ç–µ—Ö–Ω—ñ–∫–æ—é ---
function openTechManager() {
  document.getElementById("techModal").style.display = "flex";
  renderTechList();
}

// --- –ó–∞–∫—Ä–∏—Ç–∏ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ ---
function closeTechManager() {
  document.getElementById("techModal").style.display = "none";
}

// --- –î–æ–¥–∞—Ç–∏ —Ç–µ—Ö–Ω—ñ–∫—É —è–∫ –æ–±'—î–∫—Ç ---
async function addTech() {
  const group = document.getElementById("groupSelect").value;
  const name = document.getElementById("newTechName").value.trim();
  
  const internal = document.getElementById("newTechInternal").value.trim();
  const operator = document.getElementById("newTechOperator").value.trim();

  if (!group || !name) {
    alert("–ù–∞–∑–≤–∞ —Ç–∞ –≥—Ä—É–ø–∞ –æ–±–æ–≤'—è–∑–∫–æ–≤—ñ!");
    return;
  }

  const newItem = { name, internal, operator };

  techGroups[group] = techGroups[group] || [];

  const duplicate = techGroups[group].some(t => t.name.toLowerCase() === name.toLowerCase());
  if (duplicate) {
    alert("–¢–µ—Ö–Ω—ñ–∫–∞ –∑ —Ç–∞–∫–æ—é –Ω–∞–∑–≤–æ—é –≤–∂–µ —ñ—Å–Ω—É—î!");
    return;
  }

  techGroups[group].push(newItem);

  document.getElementById("newTechName").value = "";
 
  document.getElementById("newTechInternal").value = "";
  document.getElementById("newTechOperator").value = "";

  await saveToFirebase();
  renderTechList();
}

// --- –í—ñ–¥–æ–±—Ä–∞–∑–∏—Ç–∏ —Å–ø–∏—Å–æ–∫ —Ç–µ—Ö–Ω—ñ–∫–∏ —É –≤–∏–≥–ª—è–¥—ñ —Ç–∞–±–ª–∏—Ü—ñ ---
function renderTechList() {
  const group = document.getElementById("groupSelect").value;
  const tbody = document.getElementById("techList");
  tbody.innerHTML = "";

  const list = techGroups[group] || [];
  list.forEach((tech, i) => {
    const row = document.createElement("tr");
    row.innerHTML = `
  <td>${tech.name}</td>
  <td>${tech.internal || ""}</td>
  <td><span class="edit-btn" onclick="editOperator('${group}', ${i})">${tech.operator || "(—Ä–µ–¥–∞–≥—É–≤–∞—Ç–∏)"}</span></td>
  <td><button style="color:red;" onclick="deleteTech('${group}', ${i})">‚úñ</button></td>
`;

    tbody.appendChild(row);
  });
}

// --- –í–∏–¥–∞–ª–∏—Ç–∏ —Ç–µ—Ö–Ω—ñ–∫—É ---
async function deleteTech(group, index) {
  if (!confirm("–í–∏–¥–∞–ª–∏—Ç–∏ —Ü—é —Ç–µ—Ö–Ω—ñ–∫—É?")) return;
  techGroups[group].splice(index, 1);
  await saveToFirebase();
  renderTechList();
}

// --- –û–Ω–æ–≤–∏—Ç–∏ —Å–ø–∏—Å–æ–∫ —Ç–µ—Ö–Ω—ñ–∫–∏ —É –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ñ (–≤–∏–ø–∞–¥–∞—é—á–∏–π —Å–ø–∏—Å–æ–∫) ---
function updateTechOptions() {
  const group = document.getElementById("installGroup").value;
  const techSelect = document.getElementById("installTech");
  techSelect.innerHTML = '<option value="">-- –≤–∏–±–µ—Ä—ñ—Ç—å —Ç–µ—Ö–Ω—ñ–∫—É --</option>';

  const list = techGroups[group] || [];
  list.forEach(item => {
    const opt = document.createElement("option");
    opt.value = item.name;
    const internal = item.internal ? item.internal : "–±–µ–∑ ‚Ññ";
    const operator = item.operator ? item.operator : "–±–µ–∑ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞";
    opt.textContent = `${item.name} (${internal}, ${operator})`;
    techSelect.appendChild(opt);
  });
}


// --- –ü–æ–∫–∞–∑–∞—Ç–∏/—Å—Ö–æ–≤–∞—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è ---
function toggleHistory() {
  historyVisible = !historyVisible;
  document.getElementById("historyTable").style.display = historyVisible ? "table" : "none";
}

// --- –ü–æ–±—É–¥–æ–≤–∞ —ñ—Å—Ç–æ—Ä—ñ—ó –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è ---
function renderHistory() {
  const tbody = document.getElementById("historyBody");
  const filter = document.getElementById("historySearchInput").value.toLowerCase();
  tbody.innerHTML = "";

  historyLog.forEach((entry, index) => {
    if (
      entry.catalog.toLowerCase().includes(filter) ||
      (entry.name && entry.name.toLowerCase().includes(filter))
    ) {
      const row = tbody.insertRow();
      row.insertCell(0).textContent = entry.catalog;
      row.insertCell(1).textContent = entry.altCatalog || "";
      row.insertCell(2).textContent = entry.name;
      row.insertCell(3).textContent = entry.qty;
      row.insertCell(4).textContent = entry.date;
      row.insertCell(5).textContent = entry.tech;
      row.insertCell(6).textContent = entry.internal || "";
      row.insertCell(7).textContent = entry.operator || "";

      const delCell = row.insertCell(8);
      delCell.innerHTML = `<span class="delete-btn" onclick="deleteInstallRow(${index})">üóë</span>`;
    }
  });
}



// --- –ü–æ–∫–∞–∑–∞—Ç–∏/—Å—Ö–æ–≤–∞—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é –Ω–∞–¥—Ö–æ–¥–∂–µ–Ω—å ---
function renderArrivalHistory() {
  const tbody = document.getElementById("arrivalBody");
  const filter = document.getElementById("arrivalSearchInput").value.toLowerCase();
  tbody.innerHTML = "";

  arrivalLog.forEach((entry, index) => {
    const catalogMatch = entry.catalog.toLowerCase().includes(filter);
    const nameMatch = entry.name && entry.name.toLowerCase().includes(filter);
    const supplierMatch = entry.supplier && entry.supplier.toLowerCase().includes(filter);

    if (catalogMatch || nameMatch || supplierMatch) {
      const row = tbody.insertRow();
      row.insertCell(0).textContent = entry.catalog;
      row.insertCell(1).textContent = entry.altCatalog || "";
      row.insertCell(2).textContent = entry.name;
      row.insertCell(3).textContent = entry.qty;
      row.insertCell(4).textContent = entry.date;
      row.insertCell(5).textContent = entry.location;
      row.insertCell(6).textContent = entry.supplier;

      const delCell = row.insertCell(7);
      delCell.innerHTML = `<span class="delete-btn" onclick="deleteArrivalRow(${index})">üóë</span>`;
    }
  });
}



// --- –ï–∫—Å–ø–æ—Ä—Ç —Å–∫–ª–∞–¥—É —É Excel ---
function exportToExcel() {
const exportData = partsData
  .filter(p => p && p.catalog && p.name && p.quantity > 0) // üí° –ø—Ä–∏–±–∏—Ä–∞—î–º–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ñ –æ–± º—î–∫—Ç–∏
  .map(p => ({
    "–ö–∞—Ç–∞–ª–æ–∂–Ω–∏–π –Ω–æ–º–µ—Ä": p.catalog,
    "‚Ññ –Ω–µ –æ—Ä–∏–≥—ñ–Ω–∞–ª": p.altCatalog || "",
    "–ù–∞–π–º–µ–Ω—É–≤–∞–Ω–Ω—è": p.name,
    "–ö—ñ–ª—å–∫—ñ—Å—Ç—å": p.quantity,
    "–ú—ñ—Å—Ü–µ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è": p.location,
    "–î–∞—Ç–∞ –Ω–∞–¥—Ö–æ–¥–∂–µ–Ω–Ω—è": p.arrival,
    "–î–∞—Ç–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è": p.installed || "",
    "–ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫": p.supplier
  }));
  const worksheet = XLSX.utils.json_to_sheet(exportData);
  const workbook = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(workbook, worksheet, "–°–∫–ª–∞–¥");
  XLSX.writeFile(workbook, "—Å–∫–ª–∞–¥.xlsx");
}


// --- –ï–∫—Å–ø–æ—Ä—Ç –ø–∞—Ä–∫—É —Ç–µ—Ö–Ω—ñ–∫–∏ —É Excel ---
function exportTechPark() {
  const exportData = [];

  for (const group in techGroups) {
    techGroups[group].forEach(tech => {
      exportData.push({
        "–ì—Ä—É–ø–∞": group,
        "–ù–∞–∑–≤–∞": tech.name || "",
        "–í–Ω—É—Ç—Ä. –Ω–æ–º–µ—Ä": tech.internal || "",
        "–û–ø–µ—Ä–∞—Ç–æ—Ä": tech.operator || ""
      });
    });
  }

  const worksheet = XLSX.utils.json_to_sheet(exportData);
  const workbook = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(workbook, worksheet, "–¢–µ—Ö–Ω—ñ–∫–∞");
  XLSX.writeFile(workbook, "—Ç–µ—Ö–Ω—ñ–∫–∞.xlsx");
}


// --- –ï–∫—Å–ø–æ—Ä—Ç –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—å –ø–æ –¥—ñ–∞–ø–∞–∑–æ–Ω—É –¥–∞—Ç ---
function exportFilteredInstallations() {
  const from = new Date(document.getElementById("installFrom").value);
  const to = new Date(document.getElementById("installTo").value);
  if (isNaN(from) || isNaN(to)) {
    alert("–û–±–µ—Ä—ñ—Ç—å –¥—ñ–∞–ø–∞–∑–æ–Ω –¥–∞—Ç!");
    return;
  }

  const filtered = historyLog.filter(entry => {
    const entryDate = new Date(entry.date.split('.').reverse().join('-'));
    return entryDate >= from && entryDate <= to;
  });

 const exportData = filtered.map(e => ({
  "–ö–∞—Ç–∞–ª–æ–∂–Ω–∏–π –Ω–æ–º–µ—Ä": e.catalog,
   "‚Ññ –Ω–µ –æ—Ä–∏–≥—ñ–Ω–∞–ª": e.altCatalog || "",
  "–ù–∞–π–º–µ–Ω—É–≤–∞–Ω–Ω—è": e.name,
  "–ö—ñ–ª—å–∫—ñ—Å—Ç—å": e.qty,
  "–î–∞—Ç–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è": e.date,
  "–¢–µ—Ö–Ω—ñ–∫–∞": e.tech,
  "–í–Ω—É—Ç—Ä. –Ω–æ–º–µ—Ä": e.internal || "",
  "–û–ø–µ—Ä–∞—Ç–æ—Ä": e.operator || ""
}));


  const worksheet = XLSX.utils.json_to_sheet(exportData);
  const workbook = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(workbook, worksheet, "–í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è");
  XLSX.writeFile(workbook, "–≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è_–ø–æ_–¥–∞—Ç—ñ.xlsx");
}


// --- –ï–∫—Å–ø–æ—Ä—Ç –Ω–∞–¥—Ö–æ–¥–∂–µ–Ω—å –ø–æ –¥—ñ–∞–ø–∞–∑–æ–Ω—É –¥–∞—Ç ---
function exportFilteredArrivals() {
  const from = new Date(document.getElementById("arrivalFrom").value);
  const to = new Date(document.getElementById("arrivalTo").value);
  if (isNaN(from) || isNaN(to)) {
    alert("–û–±–µ—Ä—ñ—Ç—å –¥—ñ–∞–ø–∞–∑–æ–Ω –¥–∞—Ç!");
    return;
  }

  const filtered = arrivalLog.filter(entry => {
    const entryDate = new Date(entry.date.split('.').reverse().join('-'));
    return entryDate >= from && entryDate <= to;
  });

  const exportData = filtered.map(e => ({
    "–ö–∞—Ç–∞–ª–æ–∂–Ω–∏–π –Ω–æ–º–µ—Ä": e.catalog,
    "‚Ññ –Ω–µ –æ—Ä–∏–≥—ñ–Ω–∞–ª": e.altCatalog || "",
    "–ù–∞–π–º–µ–Ω—É–≤–∞–Ω–Ω—è": e.name,
    "–ö—ñ–ª—å–∫—ñ—Å—Ç—å": e.qty,
    "–î–∞—Ç–∞ –Ω–∞–¥—Ö–æ–¥–∂–µ–Ω–Ω—è": e.date,
    "–ú—ñ—Å—Ü–µ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è": e.location,
    "–ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫": e.supplier
  }));

  const worksheet = XLSX.utils.json_to_sheet(exportData);
  const workbook = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(workbook, worksheet, "–ù–∞–¥—Ö–æ–¥–∂–µ–Ω–Ω—è");
  XLSX.writeFile(workbook, "–Ω–∞–¥—Ö–æ–¥–∂–µ–Ω–Ω—è_–ø–æ_–¥–∞—Ç—ñ.xlsx");
}

  // --- –û—á–∏—Å—Ç–∏—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è ---
async function clearInstallHistory() {
  if (!confirm("–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –ø–æ–≤–Ω—ñ—Å—Ç—é –æ—á–∏—Å—Ç–∏—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è?")) return;
  historyLog = [];
  await saveToFirebase();
  renderHistory();
  alert("–Ü—Å—Ç–æ—Ä—ñ—é –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –æ—á–∏—â–µ–Ω–æ! ‚úÖ");
}

// --- –û—á–∏—Å—Ç–∏—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é –Ω–∞–¥—Ö–æ–¥–∂–µ–Ω—å ---
async function clearArrivalHistory() {
  if (!confirm("–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –ø–æ–≤–Ω—ñ—Å—Ç—é –æ—á–∏—Å—Ç–∏—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é –Ω–∞–¥—Ö–æ–¥–∂–µ–Ω—å?")) return;
  arrivalLog = [];
  await saveToFirebase();
  renderArrivalHistory();
  alert("–Ü—Å—Ç–æ—Ä—ñ—é –Ω–∞–¥—Ö–æ–¥–∂–µ–Ω—å –æ—á–∏—â–µ–Ω–æ! ‚úÖ");
}
// --- –§—É–Ω–∫—Ü—ñ—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ PIN-–∫–æ–¥—É ---
function verifyPin() {
  const pin = prompt("–í–≤–µ–¥—ñ—Ç—å PIN-–∫–æ–¥:");
  return pin === "0918";
}

// --- –û—á–∏—Å—Ç–∏—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑ PIN ---
async function clearInstallHistory() {
  if (!verifyPin()) {
    alert("–ù–µ–≤—ñ—Ä–Ω–∏–π PIN-–∫–æ–¥!");
    return;
  }
  if (!confirm("–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –ø–æ–≤–Ω—ñ—Å—Ç—é –æ—á–∏—Å—Ç–∏—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è?")) return;
  historyLog = [];
  await saveToFirebase();
  renderHistory();
  alert("–Ü—Å—Ç–æ—Ä—ñ—é –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –æ—á–∏—â–µ–Ω–æ! ‚úÖ");
}

// --- –û—á–∏—Å—Ç–∏—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é –Ω–∞–¥—Ö–æ–¥–∂–µ–Ω—å –∑ PIN ---
async function clearArrivalHistory() {
  if (!verifyPin()) {
    alert("–ù–µ–≤—ñ—Ä–Ω–∏–π PIN-–∫–æ–¥!");
    return;
  }
  if (!confirm("–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –ø–æ–≤–Ω—ñ—Å—Ç—é –æ—á–∏—Å—Ç–∏—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é –Ω–∞–¥—Ö–æ–¥–∂–µ–Ω—å?")) return;
  arrivalLog = [];
  await saveToFirebase();
  renderArrivalHistory();
  alert("–Ü—Å—Ç–æ—Ä—ñ—é –Ω–∞–¥—Ö–æ–¥–∂–µ–Ω—å –æ—á–∏—â–µ–Ω–æ! ‚úÖ");
}

// --- –í–∏–¥–∞–ª–∏—Ç–∏ –∑–∞–ø—á–∞—Å—Ç–∏–Ω—É –∑ PIN ---
async function deleteRow(index) {
  if (!verifyPin()) {
    alert("–ù–µ–≤—ñ—Ä–Ω–∏–π PIN-–∫–æ–¥!");
    return;
  }
  const item = partsData[index];
  if (!confirm(`–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ –∑–∞–ø—á–∞—Å—Ç–∏–Ω—É: ${item.name}?`)) return;
  partsData.splice(index, 1);
  await saveToFirebase();
  renderTable();
  alert("–ó–∞–ø—á–∞—Å—Ç–∏–Ω—É –≤–∏–¥–∞–ª–µ–Ω–æ! ‚úÖ");
}
function toggleInstallExport() {
  const block = document.getElementById("installExportBlock");
  block.style.display = block.style.display === "none" ? "block" : "none";
}

function toggleArrivalExport() {
  const block = document.getElementById("arrivalExportBlock");
  block.style.display = block.style.display === "none" ? "block" : "none";
}
async function editLocation(index) {
  const item = partsData[index];
  const newLocation = prompt(`–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –º—ñ—Å—Ü–µ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –¥–ª—è "${item.name}":`, item.location);
  if (newLocation !== null && newLocation.trim() !== "") {
    item.location = newLocation.trim();
    await saveToFirebase();
    renderTable();
    alert("–ú—ñ—Å—Ü–µ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –æ–Ω–æ–≤–ª–µ–Ω–æ ‚úÖ");
  }
}
async function editOperator(group, index) {
  const current = techGroups[group][index];
  const newOp = prompt(`–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è "${current.name}":`, current.operator || "");
  if (newOp !== null) {
    current.operator = newOp.trim();
    await saveToFirebase();
    renderTechList();
    alert("–û–ø–µ—Ä–∞—Ç–æ—Ä–∞ –æ–Ω–æ–≤–ª–µ–Ω–æ ‚úÖ");
  }
}
function toggleArrivalHistory() {
  arrivalVisible = !arrivalVisible;
  document.getElementById("arrivalHistoryTable").style.display = arrivalVisible ? "table" : "none";
}
async function handleDocxImport() {
  const fileInput = document.getElementById("docxInput");
  const file = fileInput.files[0];
  if (!file) {
    alert("–û–±–µ—Ä—ñ—Ç—å .docx —Ñ–∞–π–ª –¥–ª—è —ñ–º–ø–æ—Ä—Ç—É.");
    return;
  }

  const location = prompt("–í–≤–µ–¥—ñ—Ç—å –º—ñ—Å—Ü–µ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è:");
  if (!location) {
    alert("–ú—ñ—Å—Ü–µ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –æ–±–æ–≤'—è–∑–∫–æ–≤–µ!");
    return;
  }

  const supplier = prompt("–í–≤–µ–¥—ñ—Ç—å –ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫–∞:");
  if (!supplier) {
    alert("–ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫ –æ–±–æ–≤'—è–∑–∫–æ–≤–∏–π!");
    return;
  }

  const arrayBuffer = await file.arrayBuffer();
  const result = await mammoth.extractRawText({ arrayBuffer });
  const text = result.value;

  const lines = text
    .split('\n')
    .map(line => line.trim())
    .filter(line => line !== "");

  const entries = [];
  const today = new Date().toLocaleDateString("uk-UA");

  for (let i = 0; i < lines.length - 2; i++) {
    const catalog = lines[i];
    const name = lines[i + 1];
    const qtyRaw = lines[i + 2].replace(",", ".");
    const qty = parseFloat(qtyRaw);

    if (
      /^\d/.test(catalog) && // –∞—Ä—Ç–∏–∫—É–ª –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è –∑ —Ü–∏—Ñ—Ä–∏
      name.length > 2 &&
      !isNaN(qty)
    ) {
      const entry = {
        catalog,
        altCatalog: "",
        name,
        quantity: qty,
        location,
        installed: "",
        arrival: today,
        supplier
      };

      partsData.push(entry);

      arrivalLog.push({
        catalog,
        altCatalog: "",
        name,
        qty,
        date: today,
        location,
        supplier
      });

      i += 2; // –ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ —Ü—ñ —Ä—è–¥–∫–∏, –±–æ –≤–∂–µ –æ–±—Ä–æ–±–ª–µ–Ω—ñ
    }
  }

  if (entries.length === 0 && arrivalLog.length === 0) {
    alert("–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∂–æ–¥–Ω–æ–≥–æ –≤–∞–ª—ñ–¥–Ω–æ–≥–æ –∑–∞–ø–∏—Å—É.");
    return;
  }

  await saveToFirebase();
  renderTable();
  renderArrivalHistory();
  alert(`‚úÖ –£—Å–ø—ñ—à–Ω–æ —ñ–º–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ ${arrivalLog.length} –∑–∞–ø–∏—Å—ñ–≤`);
  fileInput.value = ""; // –æ—á–∏—â–µ–Ω–Ω—è –ø–æ–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
}
async function deleteInstallRow(index) {
  if (!verifyPin()) {
    alert("–ù–µ–≤—ñ—Ä–Ω–∏–π PIN-–∫–æ–¥!");
    return;
  }
  const item = historyLog[index];
  if (!confirm(`–í–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è "${item.name}" (${item.date})?`)) return;

  historyLog.splice(index, 1);
  await saveToFirebase();
  renderHistory();
  alert("–ó–∞–ø–∏—Å –≤–∏–¥–∞–ª–µ–Ω–æ ‚úÖ");
}
async function deleteArrivalRow(index) {
  if (!verifyPin()) {
    alert("–ù–µ–≤—ñ—Ä–Ω–∏–π PIN-–∫–æ–¥!");
    return;
  }

  const item = arrivalLog[index];
  const confirmDel = confirm(`–í–∏–¥–∞–ª–∏—Ç–∏ –Ω–∞–¥—Ö–æ–¥–∂–µ–Ω–Ω—è "${item.name}" (${item.date})?`);
  if (!confirmDel) return;

  arrivalLog.splice(index, 1);
  await saveToFirebase();
  renderArrivalHistory();
  alert("–ó–∞–ø–∏—Å —É—Å–ø—ñ—à–Ω–æ –≤–∏–¥–∞–ª–µ–Ω–æ ‚úÖ");
}

</script>
</body>
</html>



<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–°–∫–ª–∞–¥ –∑–∞–ø—á–∞—Å—Ç–µ–π</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js">// === –î–û–ë–ê–í–ö–ê –û–°–ù–û–í–ù–´–• –§–£–ù–ö–¶–ò–ô ===

function renderTable() {
  const tbody = document.querySelector("#partsTable tbody");
  tbody.innerHTML = "";
  const filter = document.getElementById("searchInput").value.toLowerCase();
  let counter = 1;
  partsData.forEach((item, index) => {
    if (
      item.quantity > 0 &&
      (item.name.toLowerCase().includes(filter) ||
       item.catalog.toLowerCase().includes(filter) ||
       item.location.toLowerCase().includes(filter))
    ) {
      const row = tbody.insertRow();
      row.insertCell(0).textContent = counter++;
      row.insertCell(1).textContent = item.catalog;
      row.insertCell(2).textContent = item.name;
      row.insertCell(3).textContent = item.quantity;
      row.insertCell(4).textContent = item.location;
      row.insertCell(5).textContent = item.arrival;
      row.insertCell(6).textContent = item.installed || "";
      row.insertCell(7).innerHTML = `
        <span class="install-btn" onclick="startInstall(${index})">üõ†</span> |
        <span class="delete-btn" onclick="deleteRow(${index})">üóë</span>`;
    }
  });
}

function saveEntry() {
  const name = document.getElementById("name").value.trim();
  const catalog = document.getElementById("catalog").value.trim();
  const quantity = parseInt(document.getElementById("quantity").value.trim());
  const location = document.getElementById("location").value.trim();
  const installed = document.getElementById("installed").value;
  if (!name || !catalog || isNaN(quantity) || !location) {
    alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è");
    return;
  }
  const now = new Date();
  const arrival = now.toLocaleDateString("ru-RU");
  const entry = { name, catalog, quantity, location, installed, arrival };
  if (editIndex !== null) {
    partsData[editIndex] = entry;
    editIndex = null;
  } else {
    const existing = partsData.find(p => p.catalog.toLowerCase() === catalog.toLowerCase());
    if (existing) {
      existing.quantity += quantity;
      existing.arrival = arrival;
    } else {
      partsData.push(entry);
    }
    arrivalLog.push({ catalog, name, qty: quantity, date: arrival, location });
  }
  saveToLocalStorage();
  renderTable();
  toggleForm(false);
}

function confirmInstall() {
  const qty = parseInt(document.getElementById("installQty").value);
  const group = document.getElementById("installGroup").value;
  const tech = document.getElementById("installTech").value;
  if (currentInstallIndex === null || isNaN(qty) || qty <= 0 || !group || !tech) {
    alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏");
    return;
  }
  const part = partsData[currentInstallIndex];
  if (qty > part.quantity) {
    alert("–ù–µ–ª—å–∑—è —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–æ–ª—å—à–µ, —á–µ–º –Ω–∞ —Å–∫–ª–∞–¥–µ");
    return;
  }
  part.quantity -= qty;
  part.installed = new Date().toISOString().split("T")[0];
  historyLog.push({
    catalog: part.catalog,
    name: part.name,
    qty,
    date: part.installed,
    tech: `${group} ‚Äî ${tech}`
  });
  saveToLocalStorage();
  renderTable();
  renderHistory();
  cancelInstall();
}

function cancelInstall() {
  currentInstallIndex = null;
  document.getElementById("installRow").style.display = "none";
}

function startInstall(index) {
  currentInstallIndex = index;
  document.getElementById("installQty").value = "";
  document.getElementById("installGroup").value = "";
  document.getElementById("installTech").innerHTML = '<option value="">-- –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–µ—Ö–Ω–∏–∫—É --</option>';
  document.getElementById("installRow").style.display = "block";
  window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
}

function deleteRow(index) {
  if (confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç—É —Å—Ç—Ä–æ–∫—É?")) {
    partsData.splice(index, 1);
    saveToLocalStorage();
    renderTable();
  }
}

function renderHistory(filterCatalog = null) {
  const tbody = document.getElementById("historyBody");
  tbody.innerHTML = "";
  const inputFilter = document.getElementById("historySearchInput")?.value.toLowerCase() || "";
  const catalogFilter = filterCatalog?.toLowerCase() || "";
  historyLog.forEach(entry => {
    const entryCatalog = entry.catalog.toLowerCase();
    const entryName = entry.name.toLowerCase();
    const matchesCatalog = !catalogFilter || entryCatalog === catalogFilter;
    const matchesInput = !inputFilter || entryCatalog.includes(inputFilter) || entryName.includes(inputFilter);
    if (matchesCatalog && matchesInput) {
      const row = tbody.insertRow();
      row.insertCell(0).textContent = entry.catalog;
      row.insertCell(1).textContent = entry.name;
      row.insertCell(2).textContent = entry.qty;
      row.insertCell(3).textContent = entry.date;
      row.insertCell(4).textContent = entry.tech;
    }
  });
}

function renderArrivalHistory() {
  const tbody = document.getElementById("arrivalBody");
  tbody.innerHTML = "";
  arrivalLog.forEach(entry => {
    const row = tbody.insertRow();
    row.insertCell(0).textContent = entry.catalog;
    row.insertCell(1).textContent = entry.name;
    row.insertCell(2).textContent = entry.qty;
    row.insertCell(3).textContent = entry.date;
    row.insertCell(4).textContent = entry.location;
  });
}
</script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f0f0f0; }
    input, button, select { padding: 6px; margin: 5px 5px 5px 0; }
    .edit-btn, .delete-btn, .install-btn, .history-btn { cursor: pointer; color: blue; }
    .modal {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); justify-content: center; align-items: center;
    }
    .modal-content {
      background: white; padding: 20px; border-radius: 5px; min-width: 300px;
    }
    #installRow {
      display: none;
      padding: 10px;
      border: 1px solid #ccc;
      margin-bottom: 20px;
      background: #f9f9f9;
    }
    #historyTable, #arrivalHistoryTable {
      margin-top: 30px;
    }
  </style>
</head>
<body>
  <h2>–°–∫–ª–∞–¥ —Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–ø—á–∞—Å—Ç–µ–π</h2>

  <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫...">
  <button onclick="toggleForm()">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é</button>
  <button onclick="exportToExcel()">–≠–∫—Å–ø–æ—Ä—Ç —Å–∫–ª–∞–¥–∞</button>
  <button onclick="exportTechPark()">–≠–∫—Å–ø–æ—Ä—Ç —Ç–µ—Ö–Ω–∏–∫–∏</button>
  <button onclick="openTechManager()">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Ö–Ω–∏–∫–æ–π</button>
  <button onclick="saveToJSON()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ JSON</button>
  <input type="file" id="jsonFileInput" style="display:none" onchange="loadFromJSON(event)">
  <button onclick="document.getElementById('jsonFileInput').click()">üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ JSON</button>
  <button onclick="toggleHistory()">üìú –û–±—â–∞—è –∏—Å—Ç–æ—Ä–∏—è</button>
  <button onclick="exportHistoryToExcel()">üì§ –≠–∫—Å–ø–æ—Ä—Ç –∏—Å—Ç–æ—Ä–∏–∏</button>
  <button onclick="toggleArrivalHistory()">üì• –ò—Å—Ç–æ—Ä–∏—è –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–π</button>

  <table id="partsTable">
    <thead>
      <tr>
        <th>‚Ññ</th>
        <th>–ö–∞—Ç–∞–ª–æ–∂–Ω—ã–π –Ω–æ–º–µ—Ä</th>
        <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
        <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
        <th>–ú–µ—Å—Ç–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è</th>
        <th>–î–∞—Ç–∞ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è</th>
        <th>–î–∞—Ç–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏</th>
        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="formRow" style="display:none;">
    <input id="name" placeholder="–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ">
    <input id="catalog" placeholder="–ö–∞—Ç–∞–ª–æ–∂–Ω—ã–π –Ω–æ–º–µ—Ä">
    <input type="number" id="quantity" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ">
    <input id="location" placeholder="–ú–µ—Å—Ç–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è">
    <input type="date" id="installed" placeholder="–î–∞—Ç–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏">
    <button onclick="saveEntry()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  </div>

  <div id="installRow">
    <strong>–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–ø—á–∞—Å—Ç–∏:</strong><br>
    <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label>
    <input type="number" id="installQty" placeholder="–°–∫–æ–ª—å–∫–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å?">
    <label>–ì—Ä—É–ø–ø–∞ —Ç–µ—Ö–Ω–∏–∫–∏:</label>
    <select id="installGroup" onchange="updateTechOptions()">
      <option value="">-- –≤—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É --</option>
      <option value="–¢—Ä–∞–∫—Ç–æ—Ä">–¢—Ä–∞–∫—Ç–æ—Ä</option>
      <option value="–ö–æ–º–±–∞–π–Ω">–ö–æ–º–±–∞–π–Ω</option>
      <option value="–û–ø—Ä—ã—Å–∫–∏–≤–∞—Ç–µ–ª—å">–û–ø—Ä—ã—Å–∫–∏–≤–∞—Ç–µ–ª—å</option>
      <option value="–°–µ—è–ª–∫–∞">–°–µ—è–ª–∫–∞</option>
      <option value="–î—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
    </select>
    <label>–¢–µ—Ö–Ω–∏–∫–∞:</label>
    <select id="installTech">
      <option value="">-- –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–µ—Ö–Ω–∏–∫—É --</option>
    </select>
    <button onclick="confirmInstall()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫—É</button>
    <button onclick="cancelInstall()">–û—Ç–º–µ–Ω–∞</button>
  </div>

  <div class="modal" id="techModal">
    <div class="modal-content">
      <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Ö–Ω–∏–∫–æ–π</h3>
      <label>–ì—Ä—É–ø–ø–∞:</label>
      <select id="groupSelect" onchange="renderTechList()">
        <option value="–¢—Ä–∞–∫—Ç–æ—Ä">–¢—Ä–∞–∫—Ç–æ—Ä</option>
        <option value="–ö–æ–º–±–∞–π–Ω">–ö–æ–º–±–∞–π–Ω</option>
        <option value="–û–ø—Ä—ã—Å–∫–∏–≤–∞—Ç–µ–ª—å">–û–ø—Ä—ã—Å–∫–∏–≤–∞—Ç–µ–ª—å</option>
        <option value="–°–µ—è–ª–∫–∞">–°–µ—è–ª–∫–∞</option>
        <option value="–î—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
      </select>
      <ul id="techList"></ul>
      <input id="newTech" placeholder="–ù–æ–≤–∞—è —Ç–µ—Ö–Ω–∏–∫–∞">
      <button onclick="addTech()">–î–æ–±–∞–≤–∏—Ç—å</button>
      <button onclick="closeTechManager()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>

  <h3>–ò—Å—Ç–æ—Ä–∏—è —É—Å—Ç–∞–Ω–æ–≤–æ–∫</h3>
  <input type="text" id="historySearchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∫–∞—Ç–∞–ª–æ–∂–Ω–æ–º—É –Ω–æ–º–µ—Ä—É –∏–ª–∏ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏—é" oninput="renderHistory()">
  <table id="historyTable" style="display:none;">
    <thead>
      <tr>
        <th>–ö–∞—Ç–∞–ª–æ–∂–Ω—ã–π –Ω–æ–º–µ—Ä</th>
        <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
        <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
        <th>–î–∞—Ç–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏</th>
        <th>–¢–µ—Ö–Ω–∏–∫–∞</th>
      </tr>
    </thead>
    <tbody id="historyBody"></tbody>
  </table>

  <h3>–ò—Å—Ç–æ—Ä–∏—è –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–π</h3>
  <table id="arrivalHistoryTable" style="display:none;">
    <thead>
      <tr>
        <th>–ö–∞—Ç–∞–ª–æ–∂–Ω—ã–π –Ω–æ–º–µ—Ä</th>
        <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
        <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
        <th>–î–∞—Ç–∞ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è</th>
        <th>–ú–µ—Å—Ç–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è</th>
      </tr>
    </thead>
    <tbody id="arrivalBody"></tbody>
  </table>
<script>
// –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
let partsData = [];
let techGroups = JSON.parse(localStorage.getItem("techGroups") || '{}');
let historyLog = JSON.parse(localStorage.getItem("historyLog") || '[]');
let arrivalLog = JSON.parse(localStorage.getItem("arrivalLog") || '[]');

let editIndex = null;
let currentInstallIndex = null;
let historyVisible = false;
let arrivalVisible = false;

// –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ localStorage
function saveToLocalStorage() {
  localStorage.setItem("partsData", JSON.stringify(partsData));
  localStorage.setItem("techGroups", JSON.stringify(techGroups));
  localStorage.setItem("historyLog", JSON.stringify(historyLog));
  localStorage.setItem("arrivalLog", JSON.stringify(arrivalLog));
}

// –ü–æ–∫–∞–∑/—Å–∫—Ä—ã—Ç–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —É—Å—Ç–∞–Ω–æ–≤–æ–∫
function toggleHistory() {
  historyVisible = !historyVisible;
  document.getElementById("historyTable").style.display = historyVisible ? "table" : "none";
  renderHistory();
}

// –ü–æ–∫–∞–∑/—Å–∫—Ä—ã—Ç–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–π
function toggleArrivalHistory() {
  arrivalVisible = !arrivalVisible;
  document.getElementById("arrivalHistoryTable").style.display = arrivalVisible ? "table" : "none";
  renderArrivalHistory();
}

// –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –∏ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –ø—Ä–∏ –≤–≤–æ–¥–µ –∫–∞—Ç–∞–ª–æ–∂–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞
setTimeout(() => {
  document.getElementById("catalog").addEventListener("input", () => {
    const cat = document.getElementById("catalog").value.trim().toLowerCase();
    const existing = partsData.find(p => p.catalog.toLowerCase() === cat);
    if (existing) {
      document.getElementById("name").value = existing.name;
      document.getElementById("location").value = existing.location;
    }
  });
}, 0);

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
window.onload = () => {
  partsData = JSON.parse(localStorage.getItem("partsData") || "[]");
  techGroups = JSON.parse(localStorage.getItem("techGroups") || "{}");
  historyLog = JSON.parse(localStorage.getItem("historyLog") || "[]");
  arrivalLog = JSON.parse(localStorage.getItem("arrivalLog") || "[]");
  renderTable();
  renderHistory();
  renderArrivalHistory();
};
</script>
</body>
</html>




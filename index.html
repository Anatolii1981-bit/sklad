<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>–°–∫–ª–∞–¥ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –∑–∞–ø—á–∞—Å—Ç–∏–Ω</title>

  <!-- –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è Firebase -->
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDcUKoOroCPgK2tg_zBv9WIji2VYsUTCZU",
      authDomain: "sklad-c6daf.firebaseapp.com",
      databaseURL: "https://sklad-c6daf-default-rtdb.europe-west1.firebasedatabase.app/",
      projectId: "sklad-c6daf",
      storageBucket: "sklad-c6daf.appspot.com",
      messagingSenderId: "1033169323962",
      appId: "1:1033169323962:web:73dd54812574d48aeabf83"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
  </script>

  <!-- –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è XLSX –¥–ª—è –µ–∫—Å–ø–æ—Ä—Ç—É -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    body { font-family: sans-serif; padding: 20px; }
    table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f0f0f0; }
    input, button, select { padding: 6px; margin: 5px 5px 5px 0; }
    .edit-btn, .delete-btn, .install-btn, .history-btn { cursor: pointer; color: blue; }
    .modal {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); justify-content: center; align-items: center;
    }
    .modal-content {
      background: white; padding: 20px; border-radius: 5px; min-width: 300px;
    }
    #installRow { display: none; padding: 10px; border: 1px solid #ccc; margin-bottom: 20px; background: #f9f9f9; }
    #historyTable, #arrivalHistoryTable { margin-top: 30px; }
  </style>
</head>

<body>
<!-- –í—ñ–∫–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó -->
<div id="authScreen" style="position:fixed; top:0; left:0; width:100%; height:100%; background:white; display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:10000;">
  <h2>–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å –¥–ª—è –≤—Ö–æ–¥—É</h2>
  <input type="password" id="authInput" placeholder="–ü–∞—Ä–æ–ª—å">
  <button onclick="checkPassword()">–£–≤—ñ–π—Ç–∏</button>
  <p id="authMessage" style="color:red; margin-top:10px;"></p>
</div>

<h2>–°–∫–ª–∞–¥ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –∑–∞–ø—á–∞—Å—Ç–∏–Ω</h2>
<input type="text" id="searchInput" placeholder="–ü–æ—à—É–∫..." oninput="renderTable()">
<button onclick="toggleForm()">–î–æ–¥–∞—Ç–∏ –Ω–æ–≤—É</button>
<button onclick="openTechManager()">–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Ç–µ—Ö–Ω—ñ–∫–æ—é</button>
<button onclick="exportToExcel()">üì§ –ï–∫—Å–ø–æ—Ä—Ç —Å–∫–ª–∞–¥—É</button>
<button onclick="exportTechPark()">üì§ –ï–∫—Å–ø–æ—Ä—Ç —Ç–µ—Ö–Ω—ñ–∫–∏</button>
<button onclick="refreshData()">üîÑ –û–Ω–æ–≤–∏—Ç–∏ –¥–∞–Ω—ñ</button>
<button onclick="logout()">üö™ –í–∏–π—Ç–∏</button>

<table id="partsTable">
  <thead>
    <tr>
      <th>‚Ññ</th>
      <th>–ö–∞—Ç–∞–ª–æ–∂–Ω–∏–π –Ω–æ–º–µ—Ä</th>
      <th>–ù–∞–π–º–µ–Ω—É–≤–∞–Ω–Ω—è</th>
      <th>–ö—ñ–ª—å–∫—ñ—Å—Ç—å</th>
      <th>–ú—ñ—Å—Ü–µ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è</th>
      <th>–î–∞—Ç–∞ –Ω–∞–¥—Ö–æ–¥–∂–µ–Ω–Ω—è</th>
      <th>–î–∞—Ç–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è</th>
      <th>–î—ñ—ó</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<!-- –§–æ—Ä–º–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –∑–∞–ø—á–∞—Å—Ç–∏–Ω–∏ -->
<div id="formRow" style="display:none;">
  <input id="catalog" placeholder="–ö–∞—Ç–∞–ª–æ–∂–Ω–∏–π –Ω–æ–º–µ—Ä">
  <input id="name" placeholder="–ù–∞–π–º–µ–Ω—É–≤–∞–Ω–Ω—è">
  <input type="number" id="quantity" placeholder="–ö—ñ–ª—å–∫—ñ—Å—Ç—å">
  <input id="location" placeholder="–ú—ñ—Å—Ü–µ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è">
  <input id="supplier" placeholder="–ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫">
  <input type="date" id="installed" placeholder="–î–∞—Ç–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è">
  <button onclick="saveEntry()">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
</div>

<!-- –ë–ª–æ–∫ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è -->
<div id="installRow" style="display:none;">
  <strong>–í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ø—á–∞—Å—Ç–∏–Ω–∏:</strong><br>
  <label>–ö—ñ–ª—å–∫—ñ—Å—Ç—å:</label>
  <input type="number" id="installQty" placeholder="–°–∫—ñ–ª—å–∫–∏ –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏?">
  <label>–ì—Ä—É–ø–∞ —Ç–µ—Ö–Ω—ñ–∫–∏:</label>
  <select id="installGroup" onchange="updateTechOptions()">
    <option value="">-- –≤–∏–±–µ—Ä—ñ—Ç—å –≥—Ä—É–ø—É --</option>
    <option value="–¢—Ä–∞–∫—Ç–æ—Ä">–¢—Ä–∞–∫—Ç–æ—Ä</option>
    <option value="–ö–æ–º–±–∞–π–Ω">–ö–æ–º–±–∞–π–Ω</option>
    <option value="–û–ø—Ä–∏—Å–∫—É–≤–∞—á">–û–ø—Ä–∏—Å–∫—É–≤–∞—á</option>
    <option value="–°—ñ–≤–∞–ª–∫–∞">–°—ñ–≤–∞–ª–∫–∞</option>
    <option value="–Ü–Ω—à–µ">–Ü–Ω—à–µ</option>
  </select>
  <label>–¢–µ—Ö–Ω—ñ–∫–∞:</label>
  <select id="installTech">
    <option value="">-- –≤–∏–±–µ—Ä—ñ—Ç—å —Ç–µ—Ö–Ω—ñ–∫—É --</option>
  </select>
  <button onclick="confirmInstall()">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è</button>
  <button onclick="cancelInstall()">–í—ñ–¥–º—ñ–Ω–∞</button>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–µ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Ç–µ—Ö–Ω—ñ–∫–æ—é -->
<div class="modal" id="techModal">
  <div class="modal-content">
    <h3>–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Ç–µ—Ö–Ω—ñ–∫–æ—é</h3>
    <label>–ì—Ä—É–ø–∞:</label>
    <select id="groupSelect" onchange="renderTechList()">
      <option value="–¢—Ä–∞–∫—Ç–æ—Ä">–¢—Ä–∞–∫—Ç–æ—Ä</option>
      <option value="–ö–æ–º–±–∞–π–Ω">–ö–æ–º–±–∞–π–Ω</option>
      <option value="–û–ø—Ä–∏—Å–∫—É–≤–∞—á">–û–ø—Ä–∏—Å–∫—É–≤–∞—á</option>
      <option value="–°—ñ–≤–∞–ª–∫–∞">–°—ñ–≤–∞–ª–∫–∞</option>
      <option value="–Ü–Ω—à–µ">–Ü–Ω—à–µ</option>
    </select>
    <ul id="techList"></ul>
    <input id="newTech" placeholder="–ù–æ–≤–∞ —Ç–µ—Ö–Ω—ñ–∫–∞">
    <button onclick="addTech()">–î–æ–¥–∞—Ç–∏</button>
    <button onclick="closeTechManager()">–ó–∞–∫—Ä–∏—Ç–∏</button>
  </div>
</div>
<!-- –Ü—Å—Ç–æ—Ä—ñ—è –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è -->
<h3>–Ü—Å—Ç–æ—Ä—ñ—è –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è</h3>
<input type="text" id="historySearchInput" placeholder="–ü–æ—à—É–∫ –ø–æ –∫–∞—Ç–∞–ª–æ–∂–Ω–æ–º—É –Ω–æ–º–µ—Ä—É –∞–±–æ –Ω–∞–π–º–µ–Ω—É–≤–∞–Ω–Ω—é" oninput="renderHistory()">
<button onclick="toggleHistory()">üìú –ü–æ–∫–∞–∑–∞—Ç–∏/—Å—Ö–æ–≤–∞—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è</button>
<div style="margin: 10px 0;">
  <label>–ó:</label>
  <input type="date" id="installFrom">
  <label>–ü–æ:</label>
  <input type="date" id="installTo">
  <button onclick="exportFilteredInstallations()">üì§ –ï–∫—Å–ø–æ—Ä—Ç –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—å –ø–æ –¥–∞—Ç—ñ</button>
</div>
<table id="historyTable" style="display:none;">
  <thead>
    <tr>
      <th>–ö–∞—Ç–∞–ª–æ–∂–Ω–∏–π –Ω–æ–º–µ—Ä</th>
      <th>–ù–∞–π–º–µ–Ω—É–≤–∞–Ω–Ω—è</th>
      <th>–ö—ñ–ª—å–∫—ñ—Å—Ç—å</th>
      <th>–î–∞—Ç–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è</th>
      <th>–¢–µ—Ö–Ω—ñ–∫–∞</th>
    </tr>
  </thead>
  <tbody id="historyBody"></tbody>
</table>

<!-- –Ü—Å—Ç–æ—Ä—ñ—è –Ω–∞–¥—Ö–æ–¥–∂–µ–Ω—å -->
<h3>–Ü—Å—Ç–æ—Ä—ñ—è –Ω–∞–¥—Ö–æ–¥–∂–µ–Ω—å</h3>
<input type="text" id="arrivalSearchInput" placeholder="–ü–æ—à—É–∫ –ø–æ –∫–∞—Ç–∞–ª–æ–∂–Ω–æ–º—É –Ω–æ–º–µ—Ä—É –∞–±–æ –Ω–∞–π–º–µ–Ω—É–≤–∞–Ω–Ω—é" oninput="renderArrivalHistory()">
<button onclick="toggleArrivalHistory()">üì• –ü–æ–∫–∞–∑–∞—Ç–∏/—Å—Ö–æ–≤–∞—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é –Ω–∞–¥—Ö–æ–¥–∂–µ–Ω—å</button>
<div style="margin: 10px 0;">
  <label>–ó:</label>
  <input type="date" id="arrivalFrom">
  <label>–ü–æ:</label>
  <input type="date" id="arrivalTo">
  <button onclick="exportFilteredArrivals()">üì§ –ï–∫—Å–ø–æ—Ä—Ç –Ω–∞–¥—Ö–æ–¥–∂–µ–Ω—å –ø–æ –¥–∞—Ç—ñ</button>
</div>
<table id="arrivalHistoryTable" style="display:none;">
  <thead>
    <tr>
      <th>–ö–∞—Ç–∞–ª–æ–∂–Ω–∏–π –Ω–æ–º–µ—Ä</th>
      <th>–ù–∞–π–º–µ–Ω—É–≤–∞–Ω–Ω—è</th>
      <th>–ö—ñ–ª—å–∫—ñ—Å—Ç—å</th>
      <th>–î–∞—Ç–∞ –Ω–∞–¥—Ö–æ–¥–∂–µ–Ω–Ω—è</th>
      <th>–ú—ñ—Å—Ü–µ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è</th>
      <th>–ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫</th>
    </tr>
  </thead>
  <tbody id="arrivalBody"></tbody>
</table>

<!-- –¢—É—Ç –¥–∞–ª—ñ –π–¥–µ –æ—Å–Ω–æ–≤–Ω–∞ –ª–æ–≥—ñ–∫–∞ —Å–∫–ª–∞–¥—É -->
<script>
// --- –ì–ª–æ–±–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ ---
let partsData = [];
let techGroups = {};
let historyLog = [];
let arrivalLog = [];
let editIndex = null;
let currentInstallIndex = null;
let historyVisible = false;
let arrivalVisible = false;

// --- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è ---
function checkPassword() {
  const input = document.getElementById("authInput").value;
  if (input === "1234") {
    localStorage.setItem("authPassed", "true");
    document.getElementById("authScreen").style.display = "none";
  } else {
    document.getElementById("authMessage").textContent = "–í –¥–æ—Å—Ç—É–ø—ñ –≤—ñ–¥–º–æ–≤–ª–µ–Ω–æ!";
  }
}

function logout() {
  localStorage.removeItem("authPassed");
  location.reload();
}

// --- –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ ---
window.onload = async () => {
  if (localStorage.getItem("authPassed") === "true") {
    document.getElementById("authScreen").style.display = "none";
  }
  await loadFromFirebase();
};

// --- –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è —ñ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑ Firebase ---
async function saveToFirebase() {
  await db.ref('warehouse').set({ partsData, techGroups, historyLog, arrivalLog });
}

async function loadFromFirebase() {
  return db.ref('warehouse').once('value').then(snapshot => {
    const data = snapshot.val();
    if (data) {
      partsData = data.partsData || [];
      techGroups = data.techGroups || {};
      historyLog = data.historyLog || [];
      arrivalLog = data.arrivalLog || [];
    }
    renderTable();
    renderHistory();
    renderArrivalHistory();
  });
}

function refreshData() {
  loadFromFirebase();
  alert("–î–∞–Ω—ñ –æ–Ω–æ–≤–ª–µ–Ω—ñ! ‚úÖ");
}
// --- –§–æ—Ä–º–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è ---
function toggleForm(force = null) {
  const form = document.getElementById("formRow");
  if (force === true) {
    form.style.display = "block";
    clearForm();
  } else if (force === false) {
    form.style.display = "none";
  } else {
    form.style.display = (form.style.display === "none") ? "block" : "none";
    if (form.style.display === "block") clearForm();
  }
}

function clearForm() {
  document.getElementById("catalog").value = "";
  document.getElementById("name").value = "";
  document.getElementById("quantity").value = "";
  document.getElementById("location").value = "";
  document.getElementById("supplier").value = "";
  document.getElementById("installed").value = "";
  document.getElementById("catalog").focus();
}

async function saveEntry() {
  const name = document.getElementById("name").value.trim();
  const catalog = document.getElementById("catalog").value.trim();
  const quantity = parseInt(document.getElementById("quantity").value.trim());
  const location = document.getElementById("location").value.trim();
  const supplier = document.getElementById("supplier").value.trim();
  const installed = document.getElementById("installed").value;

  if (!name || !catalog || isNaN(quantity) || quantity <= 0 || !location || !supplier) {
    alert("–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ!");
    return;
  }

  const now = new Date();
  const arrival = now.toLocaleDateString("uk-UA");
  const entry = { name, catalog, quantity, location, installed, arrival, supplier };

  const existing = partsData.find(p => p.catalog.toLowerCase() === catalog.toLowerCase());
  if (existing) {
    existing.quantity += quantity;
    existing.arrival = arrival;
  } else {
    partsData.push(entry);
  }
  arrivalLog.push({ catalog, name, qty: quantity, date: arrival, location, supplier });

  await saveToFirebase();
  renderTable();
  clearForm();
  alert("–ó–∞–ø—á–∞—Å—Ç–∏–Ω—É –∑–±–µ—Ä–µ–∂–µ–Ω–æ!");
}

// --- –ü–æ–±—É–¥–æ–≤–∞ —Ç–∞–±–ª–∏—Ü—ñ —Å–∫–ª–∞–¥—É ---
function renderTable() {
  const tbody = document.querySelector("#partsTable tbody");
  tbody.innerHTML = "";
  const filter = document.getElementById("searchInput").value.toLowerCase();
  let counter = 1;

  partsData.forEach((item, index) => {
    if (item.quantity > 0 && 
        (item.name.toLowerCase().includes(filter) || 
         item.catalog.toLowerCase().includes(filter) || 
         item.location.toLowerCase().includes(filter))) {
      const row = tbody.insertRow();
      row.insertCell(0).textContent = counter++;
      row.insertCell(1).textContent = item.catalog;
      row.insertCell(2).textContent = item.name;
      row.insertCell(3).textContent = item.quantity;
      row.insertCell(4).textContent = item.location;
      row.insertCell(5).textContent = item.arrival;
      row.insertCell(6).textContent = item.installed || "";
      row.insertCell(7).innerHTML = `
        <span class="install-btn" onclick="startInstall(${index})">üõ†</span> | 
        <span class="delete-btn" onclick="deleteRow(${index})">üóë</span>
      `;
    }
  });
}

// --- –¢—É—Ç –ø—Ä–æ–¥–æ–≤–∂—É—î—Ç—å—Å—è –ª–æ–≥—ñ–∫–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è, –≤–∏–¥–∞–ª–µ–Ω–Ω—è, —ñ—Å—Ç–æ—Ä—ñ—ó —ñ –µ–∫—Å–ø–æ—Ä—Ç—É ---
</script>

</body>
</html>

